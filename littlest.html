<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Littlest Way ‚Äì Rebuilt</title>
  <meta name="theme-color" content="#5a3825" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#8b4513;--primary-dark:#5d2f0e;--secondary:#2f4f4f;
      --bg:#faf8f5;--card:#fff;--text:#2b2b2b;--muted:#6b6b6b;--border:#e6dccf;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Cormorant Garamond','Georgia',serif;background:var(--bg);color:var(--text);line-height:1.6}
    h1,h2,h3{font-family:'Cinzel','Garamond',serif}
    .screen{display:none;min-height:100vh}
    .screen.active{display:block}
    /* PIN */
    #pinScreen.active{display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary-dark),var(--primary))}
    .pin-card{background:var(--card);border:1px solid var(--border);padding:2rem;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,.25);width:min(420px,92vw);text-align:center}
    .pin-card h1{color:var(--primary);letter-spacing:1px;margin-bottom:.25rem}
    .pin-sub{color:var(--muted);font-style:italic;margin-bottom:1rem}
    .pin-input{width:100%;padding:0.85rem;border:2px solid var(--border);border-radius:8px;text-align:center;font-size:1.25rem;letter-spacing:.25em}
    .pin-btn{margin-top:1rem;width:100%;padding:.85rem;border:none;border-radius:8px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .pin-hint{margin-top:.75rem;color:var(--muted);font-size:.95rem}
    .pin-error{margin-top:.75rem;color:#b00020;font-weight:700}
    /* Loading */
    #loadingScreen.active{display:flex;align-items:center;justify-content:center}
    .spinner{width:56px;height:56px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Header */
    .header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .header-wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .topbar{display:flex;gap:1rem;align-items:center;justify-content:space-between}
    .title{color:var(--primary);letter-spacing:1px}
    .actions{display:flex;gap:.5rem}
    .icon-btn{background:#fff;border:1px solid var(--border);border-radius:8px;padding:.5rem .65rem;cursor:pointer}
    .datebar{display:flex;gap:.5rem;align-items:center;justify-content:center;padding:.5rem;margin-top:.5rem}
    .datebar button{border:1px solid var(--border);background:#fff;border-radius:8px;padding:.35rem .75rem;cursor:pointer}
    .date{font-weight:700;color:var(--primary)}
    /* Tabs (wrap across 2+ lines) */
    .tabs{display:flex;flex-wrap:wrap;gap:.25rem;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:.25rem .25rem .5rem}
    .tab{flex:1 1 160px;min-width:150px;white-space:normal;text-align:center;border:none;background:transparent;padding:.6rem .4rem;border-bottom:3px solid transparent;cursor:pointer}
    .tab.active{border-bottom-color:var(--primary);color:var(--primary);background:rgba(139,69,19,.06)}
    /* Views */
    .view{display:none;max-width:1100px;margin:0 auto;padding:1rem}
    .view.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:1rem 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .btn{border:none;border-radius:8px;background:var(--primary);color:#fff;padding:.6rem .9rem;cursor:pointer}
    .btn.alt{background:var(--secondary)}
    .btn.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
    .list{display:grid;gap:.5rem}
    .item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:.75rem 1rem;background:#fff}
    .label{font-weight:700}
    .muted{color:var(--muted);font-style:italic}
    .badge{display:inline-block;background:rgba(139,69,19,.1);color:var(--primary);border:1px solid var(--primary);padding:.15rem .5rem;border-radius:999px;font-size:.85rem}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .field{width:100%;padding:.65rem;border:1px solid var(--border);border-radius:8px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    @media (max-width:700px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- PIN -->
  <section id="pinScreen" class="screen active">
    <div class="pin-card">
      <h1>Littlest Way</h1>
      <div class="pin-sub">Enter passcode to continue</div>
      <input id="pinInput" class="pin-input" type="password" inputmode="numeric" placeholder="Enter 332211" maxlength="6" autocomplete="off"/>
      <button id="pinBtn" class="pin-btn">Unlock</button>
      <div id="pinMsg" class="pin-hint">Tip: passcode is 332211</div>
      <div id="pinErr" class="pin-error" style="display:none;"></div>
    </div>
  </section>

  <!-- Loading -->
  <section id="loadingScreen" class="screen">
    <div style="text-align:center;padding:2rem">
      <div class="spinner"></div>
      <div>Loading from Firebase‚Ä¶</div>
      <div id="loadStatus" class="muted" style="margin-top:.5rem">Connecting‚Ä¶</div>
    </div>
  </section>

  <!-- App -->
  <section id="app" class="screen">
    <header class="header">
      <div class="header-wrap">
        <div class="topbar">
          <h2 class="title">Littlest Way</h2>
          <div class="actions">
            <button id="exportBtn" class="icon-btn" title="Export JSON">üì§</button>
            <button id="themeBtn" class="icon-btn" title="Toggle theme">‚òæ</button>
          </div>
        </div>
        <div class="datebar">
          <button id="prevDay">‚Üê</button>
          <div id="dateLabel" class="date">Today</div>
          <button id="nextDay">‚Üí</button>
        </div>
        <div class="tabs">
          <button data-view="dash" class="tab active">Dashboard</button>
          <button data-view="daily" class="tab">Daily Prayers</button>
          <button data-view="michael" class="tab">St. Michael</button>
          <button data-view="way" class="tab">Way of the Cross</button>
          <button data-view="silent" class="tab">Silent Prayer</button>
          <button data-view="devotions" class="tab">Devotions</button>
          <button data-view="children" class="tab">Children</button>
          <button data-view="intentions" class="tab">Intentions</button>
          <button data-view="novenas" class="tab">Novenas</button>
          <button data-view="history" class="tab">History</button>
        </div>
      </div>
    </header>

    <!-- DASH -->
    <div id="view-dash" class="view active">
      <div class="row">
        <div class="card" style="flex:1 1 260px">
          <h3>Today‚Äôs Prayers</h3>
          <div style="font-size:2rem;margin-top:.25rem" id="statToday">0</div>
          <div class="muted">Total increments for <span id="statDate"></span></div>
        </div>
        <div class="card" style="flex:1 1 260px">
          <h3>Daily Goal</h3>
          <div class="controls" style="margin-top:.5rem">
            <input id="goalInput" class="field" type="number" min="0" step="1" placeholder="Enter goal‚Ä¶"/>
            <button id="saveGoal" class="btn">Save</button>
          </div>
          <div style="margin-top:.5rem"><span id="goalPct" class="badge">0%</span></div>
        </div>
        <div class="card" style="flex:1 1 260px">
          <h3>Streak</h3>
          <div style="font-size:2rem;margin-top:.25rem" id="statStreak">0</div>
          <div class="muted">Consecutive days with any prayer</div>
        </div>
      </div>

      <div class="card">
        <h3>Quick Add</h3>
        <div class="controls" style="margin-top:.5rem;flex-wrap:wrap">
          <button class="btn" data-qadd="+1">+1</button>
          <button class="btn" data-qadd="+10">+10</button>
          <button class="btn" data-qadd="+100">+100</button>
          <button class="btn alt" data-qadd="-1">‚àí1</button>
        </div>
        <div class="muted" style="margin-top:.5rem">Updates /littlestWay/totals/YYYY-MM-DD</div>
      </div>
    </div>

    <!-- DAILY -->
    <div id="view-daily" class="view">
      <div class="card">
        <h3>Daily Prayers</h3>
        <div id="dailyList" class="list" style="margin-top:.75rem"></div>
        <div class="two" style="margin-top:.75rem">
          <input id="dailyNewName" class="field" placeholder="Add prayer (e.g., Morning Offering)"/>
          <button id="dailyAdd" class="btn">Add</button>
        </div>
        <div class="muted" style="margin-top:.5rem">Synced at /littlestWay/dailyPrayers</div>
      </div>
    </div>

    <!-- ST MICHAEL -->
    <div id="view-michael" class="view">
      <div class="card">
        <h3>Chaplet of St. Michael</h3>
        <div class="muted">Guided steps + completion counter</div>
        <div id="michaelStep" class="card" style="margin-top:.75rem">
          <div id="michaelText">Press ‚ÄúStart‚Äù.</div>
          <div class="controls" style="margin-top:.5rem">
            <button id="mStart" class="btn">Start</button>
            <button id="mPrev" class="btn ghost">‚Üê Prev</button>
            <button id="mNext" class="btn">Next ‚Üí</button>
            <button id="mDone" class="btn alt" style="display:none">Complete Chaplet</button>
          </div>
        </div>
        <div class="item">
          <div><span class="label">Completed</span><div class="muted">Full nine-choir devotion</div></div>
          <div class="controls">
            <button id="mPlus" class="btn">+1</button>
            <div id="mCount" class="badge">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WAY OF THE CROSS -->
    <div id="view-way" class="view">
      <div class="card">
        <h3>Way of the Cross</h3>
        <div id="stations" class="row" style="margin-top:.5rem"></div>
        <div class="controls" style="margin-top:.75rem">
          <button id="wayAll" class="btn">Complete All</button>
          <button id="wayReset" class="btn alt">Reset</button>
        </div>
        <div class="item" style="margin-top:.75rem">
          <div><span class="label">Total Completions</span><div class="muted">All 14 stations</div></div>
          <div id="wayCount" class="badge">0</div>
        </div>
      </div>
    </div>

    <!-- SILENT PRAYER -->
    <div id="view-silent" class="view">
      <div class="card">
        <h3>Silent Prayer</h3>
        <div style="font-size:3rem;margin:.5rem 0" id="timer">00:00</div>
        <div class="controls">
          <button id="tStart" class="btn">Start</button>
          <button id="tStop" class="btn alt" disabled>Stop</button>
        </div>
        <div class="controls" style="margin-top:.5rem">
          <button class="btn ghost" data-preset="5">5m</button>
          <button class="btn ghost" data-preset="10">10m</button>
          <button class="btn ghost" data-preset="20">20m</button>
          <button class="btn ghost" data-preset="30">30m</button>
        </div>
        <div class="item" style="margin-top:.75rem">
          <div><span class="label">Total Minutes Today</span></div>
          <div id="tTotal" class="badge">0</div>
        </div>
        <div class="card" style="margin-top:.75rem">
          <h4>Today‚Äôs Sessions</h4>
          <div id="tSessions" class="list" style="margin-top:.5rem"></div>
        </div>
      </div>
    </div>

    <!-- DEVOTIONS -->
    <div id="view-devotions" class="view">
      <div class="card">
        <h3>Devotions</h3>
        <div id="devList" class="list" style="margin-top:.75rem"></div>
        <div class="two" style="margin-top:.75rem">
          <input id="devName" class="field" placeholder="Add devotion (e.g., Rosary, Angelus)"/>
          <button id="devAdd" class="btn">Add</button>
        </div>
        <div class="muted" style="margin-top:.5rem">Each devotion can have a saved intention.</div>
      </div>
    </div>

    <!-- CHILDREN -->
    <div id="view-children" class="view">
      <div class="card">
        <h3>Children‚Äôs Prayers</h3>
        <div class="controls" style="margin-top:.5rem;flex-wrap:wrap" id="childTabs"></div>
        <div id="childList" class="list" style="margin-top:.75rem"></div>
        <div class="two" style="margin-top:.75rem">
          <input id="childNewPrayer" class="field" placeholder="Add child prayer (e.g., Night Prayer)"/>
          <button id="childAdd" class="btn">Add</button>
        </div>
      </div>
    </div>

    <!-- INTENTIONS -->
    <div id="view-intentions" class="view">
      <div class="card">
        <h3>Prayer Intentions</h3>
        <div id="intList" class="list" style="margin-top:.75rem"></div>
        <div class="two" style="margin-top:.75rem">
          <input id="intTitle" class="field" placeholder="Add intention (e.g., For Maria)"/>
          <button id="intAdd" class="btn">Add</button>
        </div>
      </div>
    </div>

    <!-- NOVENAS -->
    <div id="view-novenas" class="view">
      <div class="card">
        <h3>Novenas</h3>
        <div id="novList" class="list" style="margin-top:.75rem"></div>
        <div class="two" style="margin-top:.75rem">
          <input id="novTitle" class="field" placeholder="Novena title"/>
          <select id="novType" class="field">
            <option value="9">9-Day Novena</option>
            <option value="54">54-Day Rosary Novena</option>
          </select>
        </div>
        <div class="two" style="margin-top:.5rem">
          <input id="novFor" class="field" placeholder="Praying for (optional)"/>
          <input id="novStart" class="field" type="date"/>
        </div>
        <div style="margin-top:.5rem">
          <button id="novAdd" class="btn">Add Novena</button>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="view-history" class="view">
      <div class="card">
        <h3>Last 14 Days</h3>
        <canvas id="histChart"></canvas>
      </div>
    </div>
  </section>

  <script type="module">
    // --- Firebase (same project settings) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getDatabase, ref, set, get, update, onValue, push, increment, query, orderByKey, limitToLast
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDTX23Nf_6FZsPPf7nDdBVbXoHEQKvXr1s",
      authDomain: "littleway-53e73.firebaseapp.com",
      databaseURL: "https://littleway-53e73-default-rtdb.firebaseio.com",
      projectId: "littleway-53e73",
      storageBucket: "littleway-53e73.firebasestorage.app",
      messagingSenderId: "869175074742",
      appId: "1:869175074742:web:ccb8d0fee2e1ff21d21485"
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);

    // --- Elements ---
    const pinScreen = document.getElementById('pinScreen');
    const loadingScreen = document.getElementById('loadingScreen');
    const app = document.getElementById('app');
    const pinInput = document.getElementById('pinInput');
    const pinBtn = document.getElementById('pinBtn');
    const pinErr = document.getElementById('pinErr');
    const loadStatus = document.getElementById('loadStatus');

    const dateLabel = document.getElementById('dateLabel');
    const prevDay = document.getElementById('prevDay');
    const nextDay = document.getElementById('nextDay');

    // Views
    const viewIds = ['dash','daily','michael','way','silent','devotions','children','intentions','novenas','history'];
    const tabs = document.querySelectorAll('.tab');
    const showView = (id)=>{
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      document.getElementById('view-'+id).classList.add('active');
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.view===id));
    };
    tabs.forEach(t=>t.addEventListener('click',()=>showView(t.dataset.view)));

    // Date helpers (Europe/Berlin)
    const tz = 'Europe/Berlin';
    const toDateKey = (d)=> new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10);
    const toLabel = (d)=> d.toLocaleDateString('en-GB',{weekday:'short',year:'numeric',month:'short',day:'numeric', timeZone: tz});
    let currentDate = new Date(); // today
    const syncDateLabel = ()=>{
      dateLabel.textContent = toLabel(currentDate);
      document.getElementById('statDate').textContent = toLabel(currentDate);
    };
    prevDay.onclick=()=>{currentDate.setDate(currentDate.getDate()-1); syncDateLabel(); refreshAllForDate();};
    nextDay.onclick=()=>{currentDate.setDate(currentDate.getDate()+1); syncDateLabel(); refreshAllForDate();};
    syncDateLabel();

    // PIN
    const REQUIRED_PIN = "332211";
    const unlock = ()=>{
      if(pinInput.value.trim()===REQUIRED_PIN){
        pinScreen.classList.remove('active');
        loadingScreen.classList.add('active');
        boot();
      }else{
        pinErr.style.display='block';
        pinErr.textContent='Incorrect passcode.';
      }
    };
    pinBtn.onclick = unlock;
    pinInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){unlock();} });

    // --- State ---
    let unsubscribers = [];
    const detachAll = ()=>{unsubscribers.forEach(u=>u&&u()); unsubscribers=[];};

    // --- Paths ---
    const base = '/littlestWay';
    const pTotals = (key)=> ref(db, `${base}/totals/${key}`);
    const pGoal = ref(db, `${base}/settings/goal`);
    const pDailyList = ref(db, `${base}/dailyPrayers`);
    const pMichael = {
      count: ref(db, `${base}/stMichael/completed`)
    };
    const pWay = {
      stations: (key)=> ref(db, `${base}/way/${key}/stations`),
      total: ref(db, `${base}/wayTotal`)
    };
    const pSilent = {
      sessions: (key)=> ref(db, `${base}/silent/${key}/sessions`),
      totalMin: (key)=> ref(db, `${base}/silent/${key}/totalMinutes`)
    };
    const pDev = ref(db, `${base}/devotions`);
    const pChildren = (child)=> ({
      prayers: ref(db, `${base}/children/${child}/prayers`)
    });
    const pIntent = ref(db, `${base}/intentions`);
    const pNovenas = ref(db, `${base}/novenas`);

    // --- Boot sequence with timeout guard ---
    async function boot(){
      const timeout = setTimeout(()=>{
        loadStatus.textContent = 'Still connecting‚Ä¶ check Firebase rules & network.';
      }, 6000);

      try{
        // touch DB to ensure connectivity
        await update(ref(db, `${base}/heartbeat`), {ts: Date.now()});
        clearTimeout(timeout);
        loadStatus.textContent = 'Connected. Loading data‚Ä¶';
        await refreshAllForDate(); // set listeners
        loadingScreen.classList.remove('active');
        app.classList.add('active');
      }catch(err){
        clearTimeout(timeout);
        loadStatus.textContent = 'Error connecting to Firebase.';
        console.error(err);
      }
    }

    // --- DASHBOARD ---
    const statToday = document.getElementById('statToday');
    const goalInput = document.getElementById('goalInput');
    const saveGoal = document.getElementById('saveGoal');
    const goalPct = document.getElementById('goalPct');
    const statStreak = document.getElementById('statStreak');
    const qAddBtns = document.querySelectorAll('[data-qadd]');

    saveGoal.onclick = async ()=>{
      const v = Math.max(0, parseInt(goalInput.value||'0',10));
      await set(pGoal, v);
    };
    qAddBtns.forEach(b=>b.onclick = async ()=>{
      const val = parseInt(b.dataset.qadd.replace('+','').replace('‚àí','-').replace('‚àí','-'));
      const key = toDateKey(currentDate);
      await update(pTotals(key), {count: increment(val)});
    });

    function listenGoal(){
      const u = onValue(pGoal, (snap)=>{
        const g = snap.val()||0;
        goalInput.value = g || '';
        updateGoalPct();
      });
      unsubscribers.push(u);
    }
    function listenTodayTotal(){
      const key = toDateKey(currentDate);
      const u = onValue(pTotals(key), (snap)=>{
        const n = (snap.val() && snap.val().count) || 0;
        statToday.textContent = n;
        updateGoalPct();
      });
      unsubscribers.push(u);
    }
    function updateGoalPct(){
      const g = parseInt(goalInput.value||'0',10);
      const n = parseInt(statToday.textContent||'0',10);
      const pct = g>0 ? Math.min(100, Math.round((n/g)*100)) : 0;
      goalPct.textContent = pct + '%';
    }
    // Simple streak: count consecutive days back from today with totals>0
    async function computeStreak(){
      try{
        const q = query(ref(db, `${base}/totals`), orderByKey(), limitToLast(60));
        const snap = await get(q);
        const data = snap.val()||{};
        let streak=0;
        let d = new Date();
        while(true){
          const k = toDateKey(d);
          if(data[k] && data[k].count>0){ streak++; d.setDate(d.getDate()-1); }
          else break;
          if(streak>60) break;
        }
        statStreak.textContent = streak;
      }catch(e){ console.warn(e); }
    }

    // --- DAILY PRAYERS ---
    const dailyList = document.getElementById('dailyList');
    const dailyAdd = document.getElementById('dailyAdd');
    const dailyNewName = document.getElementById('dailyNewName');
    dailyAdd.onclick = async ()=>{
      const name = dailyNewName.value.trim();
      if(!name) return;
      const id = push(pDailyList).key;
      await set(ref(db, `${base}/dailyPrayers/${id}`), {name, order: Date.now(), active:true});
      dailyNewName.value='';
    };
    function renderDaily(data){
      dailyList.innerHTML='';
      const items = Object.entries(data||{}).sort((a,b)=>(a[1].order||0)-(b[1].order||0));
      for(const [id,pr] of items){
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<span class="label">${pr.name||'Untitled'}</span><div class="muted">check for ${toLabel(currentDate)}</div>`;
        const right = document.createElement('div'); right.className='controls';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Done';
        btn.onclick = async ()=>{
          const key = toDateKey(currentDate);
          await update(ref(db, `${base}/daily/${key}/${id}`), {done:true, ts: Date.now()});
          await update(pTotals(key), {count: increment(1)});
        };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = ()=> set(ref(db, `${base}/dailyPrayers/${id}`), null);
        right.appendChild(btn); right.appendChild(del);
        row.appendChild(left); row.appendChild(right);
        dailyList.appendChild(row);
      }
    }
    function listenDaily(){
      const u = onValue(pDailyList, s=> renderDaily(s.val()));
      unsubscribers.push(u);
    }

    // --- ST. MICHAEL ---
    const mText = document.getElementById('michaelText');
    const mStart = document.getElementById('mStart');
    const mPrev = document.getElementById('mPrev');
    const mNext = document.getElementById('mNext');
    const mDone = document.getElementById('mDone');
    const mPlus = document.getElementById('mPlus');
    const mCount = document.getElementById('mCount');

    const steps = [
      "Opening: O God, come to my assistance‚Ä¶ Glory be‚Ä¶",
      "1) Seraphim ‚Äì Our Father, 3 Hail Marys",
      "2) Cherubim ‚Äì Our Father, 3 Hail Marys",
      "3) Thrones ‚Äì Our Father, 3 Hail Marys",
      "4) Dominions ‚Äì Our Father, 3 Hail Marys",
      "5) Virtues ‚Äì Our Father, 3 Hail Marys",
      "6) Powers ‚Äì Our Father, 3 Hail Marys",
      "7) Principalities ‚Äì Our Father, 3 Hail Marys",
      "8) Archangels ‚Äì Our Father, 3 Hail Marys",
      "9) Angels ‚Äì Our Father, 3 Hail Marys",
      "Final: Our Father for St. Michael, St. Gabriel, St. Raphael, Guardian Angel",
      "Closing prayer to St. Michael"
    ];
    let stepIdx = -1;
    function showStep(){
      if(stepIdx<0){ mText.textContent='Press ‚ÄúStart‚Äù.'; mDone.style.display='none'; return; }
      mText.textContent = steps[stepIdx];
      mDone.style.display = (stepIdx===steps.length-1)?'inline-block':'none';
    }
    mStart.onclick = ()=>{ stepIdx=0; showStep(); };
    mPrev.onclick = ()=>{ stepIdx=Math.max(0, stepIdx-1); showStep(); };
    mNext.onclick = ()=>{ stepIdx=Math.min(steps.length-1, stepIdx+1); showStep(); };
    mDone.onclick = async ()=>{
      const key = toDateKey(currentDate);
      await update(pMichael.count, {value: increment(1)});
      await update(pTotals(key), {count: increment(1)});
      stepIdx=-1; showStep();
    };
    mPlus.onclick = async ()=>{
      const key = toDateKey(currentDate);
      await update(pMichael.count, {value: increment(1)});
      await update(pTotals(key), {count: increment(1)});
    };
    function listenMichael(){
      const u = onValue(pMichael.count, s=> mCount.textContent = (s.val() && s.val().value) || 0);
      unsubscribers.push(u);
    }

    // --- WAY OF THE CROSS ---
    const stationsWrap = document.getElementById('stations');
    const wayAll = document.getElementById('wayAll');
    const wayReset = document.getElementById('wayReset');
    const wayCount = document.getElementById('wayCount');
    const stationTitles = [
      "Jesus is condemned","Jesus carries His cross","Jesus falls the first time","Jesus meets His mother",
      "Simon helps Jesus","Veronica wipes His face","Jesus falls the second time","Jesus meets the women",
      "Jesus falls the third time","Jesus is stripped","Jesus is nailed to the cross","Jesus dies on the cross",
      "Jesus is taken down","Jesus is laid in the tomb"
    ];
    function renderStations(state){
      stationsWrap.innerHTML='';
      stationTitles.forEach((t,i)=>{
        const k = (state && state[i]) ? !!state[i].done : false;
        const btn = document.createElement('button');
        btn.className='btn ghost'; btn.textContent = `${i+1}. ${t}` + (k?' ‚úì':'');
        btn.onclick = async ()=>{
          const key = toDateKey(currentDate);
          await update(ref(db, `${base}/way/${key}/stations/${i}`), {done: !k, ts: Date.now()});
        };
        stationsWrap.appendChild(btn);
      });
    }
    function listenStations(){
      const key = toDateKey(currentDate);
      const u = onValue(pWay.stations(key), s=> renderStations(s.val()));
      unsubscribers.push(u);
    }
    wayAll.onclick = async ()=>{
      const key = toDateKey(currentDate);
      const updates = {};
      for(let i=0;i<14;i++){ updates[i] = {done:true, ts: Date.now()}; }
      await update(pWay.stations(key), updates);
      await update(pWay.total, {value: increment(1)});
      await update(pTotals(key), {count: increment(1)});
    };
    wayReset.onclick = async ()=>{
      const key = toDateKey(currentDate);
      await set(pWay.stations(key), null);
    };
    function listenWayTotal(){
      const u = onValue(pWay.total, s=> wayCount.textContent = (s.val() && s.val().value) || 0);
      unsubscribers.push(u);
    }

    // --- SILENT PRAYER ---
    const timerEl = document.getElementById('timer');
    const tStart = document.getElementById('tStart');
    const tStop = document.getElementById('tStop');
    const tTotal = document.getElementById('tTotal');
    const tSessions = document.getElementById('tSessions');
    let tInt = null, tSec=0, tPreset=null;

    document.querySelectorAll('[data-preset]').forEach(b=> b.onclick=()=>{
      tPreset = parseInt(b.dataset.preset,10);
    });
    function fmtMMSS(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const r=(s%60).toString().padStart(2,'0'); return `${m}:${r}`;}
    tStart.onclick = ()=>{
      if(tInt) return;
      tSec = 0;
      timerEl.textContent = '00:00';
      tStart.disabled = true; tStop.disabled=false;
      tInt = setInterval(()=>{
        tSec++; timerEl.textContent = fmtMMSS(tSec);
        if(tPreset && Math.floor(tSec/60)>=tPreset){ tStop.click(); }
      }, 1000);
    };
    tStop.onclick = async ()=>{
      if(!tInt) return;
      clearInterval(tInt); tInt=null;
      tStart.disabled=false; tStop.disabled=true;
      const key = toDateKey(currentDate);
      const minutes = Math.round(tSec/60);
      const node = push(pSilent.sessions(key));
      await set(node, {seconds:tSec, minutes, at: Date.now()});
      await update(pSilent.totalMin(key), {value: increment(minutes)});
      await update(pTotals(key), {count: increment(1)});
    };
    function listenSilent(){
      const key = toDateKey(currentDate);
      const u1 = onValue(pSilent.totalMin(key), s=> tTotal.textContent = (s.val() && s.val().value) || 0);
      const u2 = onValue(pSilent.sessions(key), s=>{
        const data = s.val()||{}; tSessions.innerHTML='';
        Object.values(data).sort((a,b)=>(a.at||0)-(b.at||0)).forEach(ses=>{
          const div = document.createElement('div'); div.className='item';
          div.innerHTML = `<span>${new Date(ses.at||Date.now()).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone: tz})}</span><span class="badge">${ses.minutes}m</span>`;
          tSessions.appendChild(div);
        });
      });
      unsubscribers.push(u1,u2);
    }

    // --- DEVOTIONS ---
    const devList = document.getElementById('devList');
    const devAdd = document.getElementById('devAdd');
    const devName = document.getElementById('devName');
    devAdd.onclick = async ()=>{
      const name = devName.value.trim(); if(!name) return;
      const id = push(pDev).key;
      await set(ref(db, `${base}/devotions/${id}`), {name, intention:''});
      devName.value='';
    };
    function renderDev(devs){
      devList.innerHTML='';
      for(const [id,dv] of Object.entries(devs||{})){
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<span class="label">${dv.name||'Devotion'}</span><div class="muted">Intention: ${dv.intention||'‚Äî'}</div>`;
        const right = document.createElement('div'); right.className='controls';
        const setInt = document.createElement('button'); setInt.className='btn'; setInt.textContent='Set Intention';
        setInt.onclick = async ()=>{
          const val = prompt('Intention for '+(dv.name||'devotion'), dv.intention||'');
          if(val!==null){ await update(ref(db, `${base}/devotions/${id}`), {intention: val}); }
        };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = ()=> set(ref(db, `${base}/devotions/${id}`), null);
        right.appendChild(setInt); right.appendChild(del);
        row.appendChild(left); row.appendChild(right);
        devList.appendChild(row);
      }
    }
    function listenDev(){ unsubscribers.push(onValue(pDev, s=> renderDev(s.val()))); }

    // --- CHILDREN ---
    const childTabs = document.getElementById('childTabs');
    const childList = document.getElementById('childList');
    const childAdd = document.getElementById('childAdd');
    const childNewPrayer = document.getElementById('childNewPrayer');
    const children = ['Agnes','Edmund','Leo','Child 4','Child 5'];
    let activeChild = 0;
    function renderChildTabs(){
      childTabs.innerHTML='';
      children.forEach((n,i)=>{
        const b = document.createElement('button');
        b.className = 'btn ghost';
        if(i===activeChild){ b.classList.add('alt'); }
        b.textContent = n;
        b.onclick = ()=>{ activeChild=i; renderChildTabs(); listenChild(); };
        childTabs.appendChild(b);
      });
    }
    renderChildTabs();
    childAdd.onclick = async ()=>{
      const name = childNewPrayer.value.trim(); if(!name) return;
      const id = push(pChildren(children[activeChild]).prayers).key;
      await set(ref(db, `${base}/children/${children[activeChild]}/prayers/${id}`), {name});
      childNewPrayer.value='';
    };
    function renderChildList(data){
      childList.innerHTML='';
      for(const [id,p] of Object.entries(data||{})){
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<span class="label">${p.name||'Prayer'}</span>`;
        const right = document.createElement('div'); right.className='controls';
        const plus = document.createElement('button'); plus.className='btn'; plus.textContent='+1';
        plus.onclick = async ()=>{
          const key = toDateKey(currentDate);
          await update(ref(db, `${base}/children/${children[activeChild]}/prayers/${id}/counts/${key}`), {value: increment(1)});
          await update(pTotals(key), {count: increment(1)});
        };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = ()=> set(ref(db, `${base}/children/${children[activeChild]}/prayers/${id}`), null);
        right.appendChild(plus); right.appendChild(del);
        row.appendChild(right);
        childList.appendChild(row);
      }
    }
    let childUnsub = null;
    function listenChild(){
      if(childUnsub) childUnsub();
      const u = onValue(pChildren(children[activeChild]).prayers, s=> renderChildList(s.val()));
      childUnsub = u; unsubscribers.push(u);
    }

    // --- INTENTIONS ---
    const intList = document.getElementById('intList');
    const intAdd = document.getElementById('intAdd');
    const intTitle = document.getElementById('intTitle');
    intAdd.onclick = async ()=>{
      const title = intTitle.value.trim(); if(!title) return;
      const id = push(pIntent).key;
      await set(ref(db, `${base}/intentions/${id}`), {title, count:0, answered:false, note:''});
      intTitle.value='';
    };
    function renderIntents(data){
      intList.innerHTML='';
      for(const [id,it] of Object.entries(data||{})){
        const row = document.createElement('div'); row.className='item';
        const left = document.createElement('div');
        left.innerHTML = `<span class="label">${it.title}</span><div class="muted">${it.answered?'Answered':'Active'}${it.note? ' ‚Äî '+it.note:''}</div>`;
        const right = document.createElement('div'); right.className='controls';
        ['+1','+10','+100','‚àí1'].forEach(lbl=>{
          const b=document.createElement('button'); b.className='btn'; b.textContent=lbl;
          b.onclick = async ()=>{
            const val = lbl==='‚àí1' ? -1 : parseInt(lbl.replace('+',''),10);
            const key = toDateKey(currentDate);
            await update(ref(db, `${base}/intentions/${id}`), {count: increment(val)});
            if(val>0){ await update(pTotals(key), {count: increment(val)}); }
          };
          right.appendChild(b);
        });
        const mark = document.createElement('button'); mark.className='btn alt'; mark.textContent='Mark answered';
        mark.onclick = async ()=>{
          const note = prompt('Optional note / thanksgiving:', it.note||'');
          await update(ref(db, `${base}/intentions/${id}`), {answered:true, note: note||''});
        };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = ()=> set(ref(db, `${base}/intentions/${id}`), null);
        const badge = document.createElement('span'); badge.className='badge'; badge.textContent = it.count||0;
        right.appendChild(mark); right.appendChild(del); right.appendChild(badge);
        row.appendChild(left); row.appendChild(right);
        intList.appendChild(row);
      }
    }
    function listenIntents(){ unsubscribers.push(onValue(pIntent, s=> renderIntents(s.val()))); }

    // --- NOVENAS ---
    const novList = document.getElementById('novList');
    const novTitle = document.getElementById('novTitle');
    const novType = document.getElementById('novType');
    const novFor = document.getElementById('novFor');
    const novStart = document.getElementById('novStart');
    const novAdd = document.getElementById('novAdd');
    novAdd.onclick = async ()=>{
      const t = novTitle.value.trim(); if(!t) return;
      const start = novStart.value || toDateKey(new Date());
      const type = parseInt(novType.value,10);
      const id = push(pNovenas).key;
      await set(ref(db, `${base}/novenas/${id}`), {title:t, type, for: (novFor.value||''), start, progress:{}});
      novTitle.value=''; novFor.value='';
    };
    function renderNovenas(data){
      novList.innerHTML='';
      for(const [id,nv] of Object.entries(data||{})){
        const days = nv.type||9;
        const start = new Date(nv.start || toDateKey(new Date()));
        const idx = Math.min(days, Math.max(0, Math.floor((currentDate - start)/(1000*60*60*24))+1));
        const done = nv.progress && nv.progress[toDateKey(currentDate)];
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div><span class="label">${nv.title}</span><div class="muted">${nv.for||'‚Äî'} ‚Ä¢ Day ${idx} of ${days}</div></div>`;
        const right = document.createElement('div'); right.className='controls';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent = done ? 'Marked' : 'Mark Today';
        btn.disabled = !!done;
        btn.onclick = async ()=>{
          await update(ref(db, `${base}/novenas/${id}/progress/${toDateKey(currentDate)}`), {done:true, ts: Date.now()});
          await update(pTotals(toDateKey(currentDate)), {count: increment(1)});
        };
        right.appendChild(btn);
        row.appendChild(right);
        novList.appendChild(row);
      }
    }
    function listenNovenas(){ unsubscribers.push(onValue(pNovenas, s=> renderNovenas(s.val()||{}))); }

    // --- HISTORY ---
    let histChart=null;
    function listenHistory(){
      const u = onValue(ref(db, `${base}/totals`), s=>{
        const data = s.val()||{};
        const labels=[]; const values=[];
        const d = new Date(currentDate);
        for(let i=13;i>=0;i--){
          const t = new Date(d); t.setDate(d.getDate()-i);
          const k = toDateKey(t);
          labels.push(t.toLocaleDateString('en-GB',{month:'short',day:'numeric', timeZone: tz}));
          values.push( (data[k] && data[k].count) || 0 );
        }
        const ctx = document.getElementById('histChart').getContext('2d');
        if(histChart){ histChart.destroy(); }
        histChart = new Chart(ctx, {
          type:'bar',
          data:{ labels, datasets:[{label:'Total per day', data: values}] },
          options:{ responsive:true, plugins:{legend:{display:false}} }
        });
      });
      unsubscribers.push(u);
    }

    // --- Export ---
    document.getElementById('exportBtn').onclick = async ()=>{
      const snap = await get(ref(db, base));
      const blob = new Blob([JSON.stringify(snap.val()||{}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'littlestWay-export.json'; a.click();
      URL.revokeObjectURL(url);
    };

    // --- Theme ---
    document.getElementById('themeBtn').onclick = ()=> document.body.classList.toggle('dark-mode');

    // --- Date refresh (recreate listeners for per-date paths) ---
    async function refreshAllForDate(){
      detachAll();
      listenGoal();
      listenTodayTotal();
      computeStreak();
      listenDaily();
      listenMichael();
      listenStations();
      listenWayTotal();
      listenSilent();
      listenDev();
      listenChild();
      listenIntents();
      listenNovenas();
      listenHistory();
    }
  </script>
</body>
</html>
