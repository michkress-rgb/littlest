<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Littlest Way - Prayer Tracker</title>
  <meta name="theme-color" content="#5a3825" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #8b4513;
      --primary-dark: #5d2f0e;
      --primary-light: #a0522d;
      --secondary: #2f4f4f;
      --secondary-light: #4a7c7c;
      --accent-gold: #d4af37;
      --accent-rose: #c17b7b;
      --bg-main: #faf8f5;
      --bg-card: #ffffff;
      --bg-overlay: rgba(0, 0, 0, 0.7);
      --text-primary: #2c2c2c;
      --text-secondary: #5a5a5a;
      --text-muted: #8a8a8a;
      --border: #e5ddd3;
      --border-dark: #d0c4b8;
      --shadow: rgba(0, 0, 0, 0.08);
      --shadow-lg: rgba(0, 0, 0, 0.15);
      --liturgical-ordinary: #2f4f4f;
      --liturgical-advent: #7b68ee;
      --liturgical-christmas: #ffffff;
      --liturgical-lent: #8b4789;
      --liturgical-easter: #ffffff;
      --liturgical-feasts: #d4af37;
    }

    body.dark-mode {
      --primary: #d4af37;
      --primary-dark: #b8941f;
      --primary-light: #e6c550;
      --secondary: #5a7d7d;
      --secondary-light: #7a9d9d;
      --accent-gold: #f0d875;
      --accent-rose: #d99999;
      --bg-main: #1a1a1a;
      --bg-card: #2a2a2a;
      --text-primary: #e5e5e5;
      --text-secondary: #b5b5b5;
      --text-muted: #858585;
      --border: #3a3a3a;
      --border-dark: #4a4a4a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cormorant Garamond', 'Georgia', serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.7;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-size: 18px;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Cinzel', 'Garamond', serif;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .screen {
      display: none;
      min-height: 100vh;
    }

    .screen.active {
      display: block;
    }

    /* === PIN SCREEN === */
    #pinScreen.active {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
    }

    .pin-container {
      text-align: center;
      padding: 3rem 2rem;
      background: var(--bg-card);
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 420px;
      width: 90%;
      border: 1px solid var(--border);
    }

    .pin-container h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
      letter-spacing: 2px;
    }

    .pin-subtitle {
      color: var(--text-secondary);
      margin-bottom: 2rem;
      font-size: 1.1rem;
      font-style: italic;
    }

    .pin-input-group {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .pin-input-group input {
      flex: 1;
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 1.25rem;
      text-align: center;
      letter-spacing: 0.5em;
      background: var(--bg-card);
      color: var(--text-primary);
      font-family: 'Cinzel', serif;
    }

    .pin-input-group input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .pin-hint {
      color: var(--text-muted);
      font-size: 0.95rem;
      font-style: italic;
    }

    /* === LOADING === */
    #loadingScreen.active {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-main);
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === BUTTONS === */
    .btn {
      padding: 0.875rem 1.5rem;
      border: 2px solid transparent;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Cinzel', serif;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }

    .btn-secondary:hover {
      background: var(--secondary-light);
    }

    .btn-icon {
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      color: var(--text-secondary);
    }

    .btn-icon:hover {
      background: var(--border);
    }

    .btn-link {
      background: none;
      border: none;
      color: var(--primary);
      text-decoration: underline;
      font-size: 0.875rem;
      cursor: pointer;
      font-family: 'Cormorant Garamond', serif;
    }

    .btn-link:hover {
      color: var(--primary-dark);
    }

    /* === HEADER === */
    .app-header {
      background: var(--bg-card);
      border-bottom: 2px solid var(--border-dark);
      padding: 1.25rem 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-header h1 {
      font-size: 1.75rem;
      color: var(--primary);
      letter-spacing: 2px;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .app-nav {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .nav-link {
      background: none;
      border: none;
      font-size: 1rem;
      color: var(--text-secondary);
      padding: 0.875rem 1.25rem;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-family: 'Cinzel', serif;
      letter-spacing: 0.5px;
      transition: all 0.2s ease;
      text-transform: uppercase;
      font-size: 0.875rem;
    }

    .nav-link:hover {
      color: var(--primary);
    }

    .nav-link.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* === MAIN CONTENT === */
    .main-content {
      padding: 2rem 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 100px;
    }

    .app-view {
      display: none;
    }

    .app-view.active {
      display: block;
    }

    /* === LITURGICAL BANNER === */
    .liturgical-banner {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px var(--shadow-lg);
      border-left: 6px solid var(--accent-gold);
    }

    .liturgical-date {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .liturgical-feast {
      font-size: 1.75rem;
      font-family: 'Cinzel', serif;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .liturgical-season {
      font-size: 1rem;
      opacity: 0.85;
      font-style: italic;
    }

    .liturgical-reading {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      font-style: italic;
      font-size: 1rem;
    }

    /* === STREAK CARD === */
    .streak-card {
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .streak-flame {
      font-size: 3rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .streak-count {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Cinzel', serif;
    }

    .streak-label {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    /* === QUOTE CARD === */
    .quote-card {
      background: var(--bg-card);
      border-left: 4px solid var(--accent-rose);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px var(--shadow);
      font-style: italic;
      position: relative;
    }

    .quote-text {
      font-size: 1.15rem;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      line-height: 1.8;
    }

    .quote-author {
      text-align: right;
      font-size: 0.95rem;
      color: var(--text-secondary);
      font-style: normal;
      font-weight: 600;
    }

    .quote-text::before {
      content: '"';
      font-size: 3rem;
      position: absolute;
      left: 0.5rem;
      top: 0;
      color: var(--accent-rose);
      opacity: 0.3;
      font-family: Georgia, serif;
    }

    /* === DAILY SUMMARY === */
    .daily-summary {
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 8px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .summary-title {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .summary-item h4 {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Cinzel', serif;
    }

    .summary-count {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Cinzel', serif;
    }

    .goal-section {
      text-align: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid var(--border);
    }

    .goal-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .goal-header h4 {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    .goal-numbers {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .goal-progress-bar {
      background: var(--border);
      border-radius: 12px;
      height: 16px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .goal-progress-fill {
      background: linear-gradient(90deg, var(--primary), var(--accent-gold));
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 12px;
    }

    /* === PRAYER SECTIONS === */
    .prayer-section {
      margin-bottom: 2.5rem;
    }

    .prayer-section h3 {
      font-size: 1.5rem;
      color: var(--primary);
      border-bottom: 2px solid var(--border-dark);
      padding-bottom: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .prayer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.75rem;
    }

    .btn-toggle {
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
      border: 2px solid var(--border-dark);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      font-family: 'Cormorant Garamond', serif;
    }

    .btn-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
      border-color: var(--primary);
    }

    .btn-toggle.active {
      background: var(--secondary);
      border-color: var(--secondary);
      color: white;
      font-weight: 700;
    }

    /* === INTENTIONS === */
    .btn-add {
      width: 100%;
      margin-bottom: 2rem;
      padding: 1.25rem;
      font-size: 1.1rem;
    }

    .intentions-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .intention-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px var(--shadow);
      border: 2px solid var(--border);
      opacity: 1;
      transition: all 0.3s ease;
    }

    .intention-card.answered {
      opacity: 0.6;
      background: var(--bg-main);
    }

    .intention-card.answered .intention-title {
      text-decoration: line-through;
    }

    .intention-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .intention-title {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .intention-note {
      font-size: 1rem;
      color: var(--text-secondary);
      margin: 0;
      font-style: italic;
    }

    .intention-actions {
      display: flex;
      gap: 0.25rem;
    }

    .intention-counter {
      text-align: center;
      padding: 1.25rem 0;
      margin: 1rem 0;
      border-top: 2px solid var(--border);
      border-bottom: 2px solid var(--border);
    }

    .counter-today {
      display: block;
      font-size: 3rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
      font-family: 'Cinzel', serif;
    }

    .counter-label {
      font-size: 0.95rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 0.5rem;
    }

    .counting-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .btn-count {
      padding: 1.25rem;
      font-size: 1.25rem;
      font-weight: 700;
      border: 2px solid var(--border-dark);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Cinzel', serif;
    }

    .btn-count:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .btn-count-1 {
      font-size: 1.75rem;
      border-color: var(--secondary);
      color: var(--secondary);
    }

    .btn-count-1:hover {
      background: var(--secondary);
      color: white;
    }

    .btn-count-10 {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-count-10:hover {
      background: var(--primary);
      color: white;
    }

    .btn-count-100 {
      border-color: var(--accent-gold);
      color: var(--accent-gold);
    }

    .btn-count-100:hover {
      background: var(--accent-gold);
      color: white;
    }

    /* === NOVENAS === */
    .novena-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px var(--shadow);
      border: 2px solid var(--border);
      margin-bottom: 1.5rem;
    }

    .novena-card.answered {
      opacity: 0.6;
      background: var(--bg-main);
    }

    .novena-card.answered .novena-title {
      text-decoration: line-through;
    }

    .novena-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .novena-title {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .novena-for {
      font-size: 1rem;
      color: var(--text-secondary);
      margin: 0;
      font-style: italic;
    }

    .novena-actions {
      display: flex;
      gap: 0.25rem;
    }

    .novena-progress {
      margin: 1rem 0;
    }

    .novena-progress-bar {
      background: var(--border);
      border-radius: 12px;
      height: 12px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .novena-progress-fill {
      background: var(--secondary);
      height: 100%;
      transition: width 0.3s ease;
    }

    .novena-progress-label {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 600;
      margin-top: 0.75rem;
    }

    .novena-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 2px solid var(--border);
    }

    .novena-dates {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .btn-check-in {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }

    .btn-check-in:disabled {
      background: var(--text-muted);
      border-color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* === ANSWERED PRAYERS === */
    .answered-prayers-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .answered-prayer-card {
      background: var(--bg-card);
      border-left: 4px solid var(--accent-gold);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .answered-prayer-title {
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .answered-prayer-date {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .answered-prayer-testimony {
      font-size: 1rem;
      color: var(--text-primary);
      line-height: 1.7;
      font-style: italic;
    }

    /* === CHARTS === */
    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
      background: var(--bg-card);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow);
      border: 2px solid var(--border);
      margin-bottom: 2rem;
    }

    /* === MODALS === */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-overlay);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 8px;
      max-width: 550px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px var(--shadow-lg);
      border: 2px solid var(--border-dark);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 2px solid var(--border);
    }

    .modal-header h2 {
      font-size: 1.75rem;
      color: var(--primary);
    }

    .modal form {
      padding: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }

    .form-group label {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Cinzel', serif;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 0.875rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      font-family: 'Cormorant Garamond', serif;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      padding: 1.5rem;
      border-top: 2px solid var(--border);
    }

    .modal-actions .btn {
      flex: 1;
    }

    /* === TOAST === */
    .toast-container {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      pointer-events: none;
    }

    .toast {
      background: var(--text-primary);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 16px var(--shadow-lg);
      font-weight: 600;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.05rem;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-success {
      background: var(--secondary);
    }

    .toast-error {
      background: #c17b7b;
    }

    /* === EMPTY STATES === */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 1.25rem;
      font-style: italic;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      body {
        font-size: 16px;
      }

      .app-header h1 {
        font-size: 1.5rem;
      }

      .liturgical-feast {
        font-size: 1.5rem;
      }

      .summary-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .prayer-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .counting-buttons {
        grid-template-columns: 1fr;
      }

      .app-nav {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .nav-link {
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <!-- PIN SCREEN -->
  <div id="pinScreen" class="screen active">
    <div class="pin-container">
      <h1>Littlest Way</h1>
      <p class="pin-subtitle">Prayer Tracker</p>
      <div class="pin-input-group">
        <input type="password" id="pinInput" inputmode="numeric" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off" />
        <button id="pinSubmit" class="btn btn-primary">Unlock</button>
      </div>
      <p class="pin-hint">Enter your 6-digit PIN</p>
    </div>
  </div>

  <!-- LOADING SCREEN -->
  <div id="loadingScreen" class="screen">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading your prayers...</p>
    </div>
  </div>

  <!-- APP SCREEN -->
  <div id="appScreen" class="screen">
    <header class="app-header">
      <div class="header-content">
        <h1>Littlest Way</h1>
        <div class="header-actions">
          <button id="themeToggle" class="btn-icon" title="Toggle theme">
            <span class="theme-icon">â˜¾</span>
          </button>
        </div>
      </div>
      <nav class="app-nav">
        <button class="nav-link active" data-view="todayView">Today</button>
        <button class="nav-link" data-view="intentionsView">Intentions</button>
        <button class="nav-link" data-view="novenasView">Novenas</button>
        <button class="nav-link" data-view="answeredView">Answered</button>
        <button class="nav-link" data-view="historyView">History</button>
      </nav>
    </header>

    <main class="main-content">
      <!-- TODAY VIEW -->
      <div id="todayView" class="app-view active">
        <!-- Liturgical Banner -->
        <div class="liturgical-banner" id="liturgicalBanner">
          <div class="liturgical-date" id="liturgicalDate">Loading...</div>
          <div class="liturgical-feast" id="liturgicalFeast">Loading liturgical information...</div>
          <div class="liturgical-season" id="liturgicalSeason"></div>
          <div class="liturgical-reading" id="liturgicalReading"></div>
        </div>

        <!-- Streak Card -->
        <div class="streak-card">
          <span class="streak-flame">ðŸ•¯</span>
          <div class="streak-count" id="streakCount">0</div>
          <div class="streak-label">Day Streak</div>
        </div>

        <!-- Daily Quote -->
        <div class="quote-card">
          <div class="quote-text" id="quoteText">Loading quote...</div>
          <div class="quote-author" id="quoteAuthor"></div>
        </div>

        <!-- Daily Summary -->
        <section class="daily-summary">
          <h3 class="summary-title">Today's Summary</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <h4>Intentions</h4>
              <p class="summary-count" id="tallyIntentionCount">0</p>
            </div>
            <div class="summary-item">
              <h4>Devotions</h4>
              <p class="summary-count" id="tallyDevotionCount">0</p>
            </div>
            <div class="summary-item">
              <h4>Hours</h4>
              <p class="summary-count" id="tallyHourCount">0</p>
            </div>
          </div>

          <div class="goal-section">
            <div class="goal-header">
              <h4>Daily Intention Goal</h4>
              <button id="setGoalBtn" class="btn-link">(Set Goal)</button>
            </div>
            <p class="goal-numbers">
              <span id="tallyGoalCount">0</span> / <span id="tallyGoalTarget">100</span>
            </p>
            <div class="goal-progress-bar">
              <div class="goal-progress-fill" id="goalProgressFill"></div>
            </div>
          </div>
        </section>

        <!-- Rosary -->
        <section class="prayer-section">
          <h3>Rosary</h3>
          <div class="prayer-grid" id="rosaryGrid">
            <button class="btn-toggle" data-type="rosary" data-key="joyful">Joyful</button>
            <button class="btn-toggle" data-type="rosary" data-key="luminous">Luminous</button>
            <button class="btn-toggle" data-type="rosary" data-key="sorrowful">Sorrowful</button>
            <button class="btn-toggle" data-type="rosary" data-key="glorious">Glorious</button>
          </div>
        </section>

        <!-- Devotions -->
        <section class="prayer-section">
          <h3>Devotions & Chaplets</h3>
          <div class="prayer-grid" id="devotionsGrid">
            <button class="btn-toggle" data-type="devotions" data-key="sevenSorrows">Seven Sorrows</button>
            <button class="btn-toggle" data-type="devotions" data-key="divineMercy">Divine Mercy</button>
            <button class="btn-toggle" data-type="devotions" data-key="holyFace">Holy Face</button>
            <button class="btn-toggle" data-type="devotions" data-key="holyWounds">Holy Wounds</button>
          </div>
        </section>

        <!-- Liturgy of the Hours -->
        <section class="prayer-section">
          <h3>Liturgy of the Hours</h3>
          <div class="prayer-grid" id="breviaryGrid">
            <button class="btn-toggle" data-type="breviary" data-key="matins">Matins</button>
            <button class="btn-toggle" data-type="breviary" data-key="lauds">Lauds</button>
            <button class="btn-toggle" data-type="breviary" data-key="terce">Terce</button>
            <button class="btn-toggle" data-type="breviary" data-key="sext">Sext</button>
            <button class="btn-toggle" data-type="breviary" data-key="none">None</button>
            <button class="btn-toggle" data-type="breviary" data-key="vespers">Vespers</button>
            <button class="btn-toggle" data-type="breviary" data-key="compline">Compline</button>
          </div>
        </section>
      </div>

      <!-- INTENTIONS VIEW -->
      <div id="intentionsView" class="app-view">
        <button id="addIntentionBtn" class="btn btn-primary btn-add">Add New Intention</button>
        <div id="intentionsList" class="intentions-list"></div>
      </div>

      <!-- NOVENAS VIEW -->
      <div id="novenasView" class="app-view">
        <button id="addNovenaBtn" class="btn btn-primary btn-add">Add New Novena</button>
        <div id="novenasList" class="novenas-list"></div>
      </div>

      <!-- ANSWERED PRAYERS VIEW -->
      <div id="answeredView" class="app-view">
        <h2 style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);">Answered Prayers</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem; font-style: italic;">
          A record of God's faithfulness
        </p>
        <div id="answeredPrayersList" class="answered-prayers-list"></div>
      </div>

      <!-- HISTORY VIEW -->
      <div id="historyView" class="app-view">
        <h2 style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary);">Prayer History</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">Prayer categories over the last 30 days</p>
        <div class="chart-container">
          <canvas id="historyChart"></canvas>
        </div>
        
        <!-- Calendar Heatmap -->
        <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--primary);">Prayer Consistency</h3>
        <div class="chart-container" style="height: 200px;">
          <canvas id="consistencyChart"></canvas>
        </div>
      </div>
    </main>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- INTENTION MODAL -->
  <div id="intentionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Intention</h2>
        <button class="btn-icon" id="closeModal">Ã—</button>
      </div>
      <form id="intentionForm">
        <div class="form-group">
          <label for="intentionTitle">Title *</label>
          <input type="text" id="intentionTitle" required maxlength="100" placeholder="e.g., For my family" />
        </div>
        <div class="form-group">
          <label for="intentionNote">Note (optional)</label>
          <textarea id="intentionNote" rows="3" maxlength="500" placeholder="Additional details..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelIntentionModal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- NOVENA MODAL -->
  <div id="novenaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="novenaModalTitle">Add Novena</h2>
        <button class="btn-icon" id="closeNovenaModal">Ã—</button>
      </div>
      <form id="novenaForm">
        <div class="form-group">
          <label for="novenaTitle">Novena Title *</label>
          <input type="text" id="novenaTitle" required maxlength="100" placeholder="e.g., Divine Mercy Novena" />
        </div>
        <div class="form-group">
          <label for="novenaFor">Intention *</label>
          <textarea id="novenaFor" rows="2" maxlength="500" placeholder="e.g., For the conversion of sinners"></textarea>
        </div>
        <div class="form-group">
          <label for="novenaType">Type *</label>
          <select id="novenaType" required>
            <option value="9">9-Day</option>
            <option value="54">54-Day (Rosary)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="novenaStartDate">Start Date *</label>
          <input type="date" id="novenaStartDate" required />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelNovenaModal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Novena</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ANSWERED PRAYER MODAL -->
  <div id="answeredModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Prayer Answered!</h2>
        <button class="btn-icon" id="closeAnsweredModal">Ã—</button>
      </div>
      <form id="answeredForm">
        <input type="hidden" id="answeredIntentionId" />
        <input type="hidden" id="answeredIntentionTitle" />
        <div class="form-group">
          <label for="answeredTestimony">Share your testimony (optional)</label>
          <textarea id="answeredTestimony" rows="5" maxlength="1000" placeholder="How did God answer this prayer? What did you learn?"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAnsweredModal">Skip</button>
          <button type="submit" class="btn btn-primary">Save Testimony</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // === CARMELITE QUOTES ===
    const carmeliteQuotes = [
      { text: "Miss no single opportunity of making some small sacrifice, here by a smiling look, there by a kindly word; always doing the smallest right and doing it all for love.", author: "St. ThÃ©rÃ¨se of Lisieux" },
      { text: "The splendor of the rose and the whiteness of the lily do not rob the little violet of its scent nor the daisy of its simple charm.", author: "St. ThÃ©rÃ¨se of Lisieux" },
      { text: "Let nothing disturb you, let nothing frighten you. All things pass away: God never changes.", author: "St. Teresa of Ãvila" },
      { text: "Prayer is nothing else than being on terms of friendship with God.", author: "St. Teresa of Ãvila" },
      { text: "In the evening of life, we will be judged on love alone.", author: "St. John of the Cross" },
      { text: "The soul that walks in love neither tires others nor grows tired.", author: "St. John of the Cross" },
      { text: "God does not ask us to do great things, only little things with great love.", author: "St. ThÃ©rÃ¨se of Lisieux" },
      { text: "Without love, deeds, even the most brilliant, count as nothing.", author: "St. ThÃ©rÃ¨se of Lisieux" },
      { text: "Be gentle to all and stern with yourself.", author: "St. Teresa of Ãvila" },
      { text: "Where there is no love, put love, and you will find love.", author: "St. John of the Cross" },
      { text: "The more we receive in silent prayer, the more we can give in our active life.", author: "Blessed Titus Brandsma" },
      { text: "I will spend my heaven doing good on earth.", author: "St. ThÃ©rÃ¨se of Lisieux" },
      { text: "Accustom yourself continually to make many acts of love, for they enkindle and melt the soul.", author: "St. Teresa of Ãvila" },
      { text: "What we need most in order to make progress is to be silent before this great God with our appetite and with our tongue.", author: "St. John of the Cross" },
      { text: "For prayer is nothing else than being on terms of friendship with God.", author: "St. Teresa of Ãvila" }
    ];

    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyC8h3coWuE2erx7QGQQkykproMDJsg3CUo",
      authDomain: "littlest-7ffe5.firebaseapp.com",
      databaseURL: "https://littlest-7ffe5-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "littlest-7ffe5",
      storageBucket: "littlest-7ffe5.appspot.com",
      messagingSenderId: "97338367295",
      appId: "1:97338367295:web:5e1075caf990514a77078a"
    };

    const CORRECT_PIN = "332211";
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayString = today.toISOString().slice(0, 10);

    let initializeApp, getDatabase, ref, push, set, update, onValue, increment, get, query, orderByKey, limitToLast;
    let app, db;
    let activeIntentions = {};
    let activeNovenas = {};
    let answeredPrayers = {};
    let todayDailyData = {};
    let globalSettings = { dailyGoal: 100 };
    let streakData = { currentStreak: 0, lastPrayerDate: null };
    let historyChart, consistencyChart;

    // === Helper Functions ===
    function showToast(message, type = "success") {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add("show"), 10);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => container.removeChild(toast), 300);
      }, 3000);
    }

    function showScreen(id) {
      ["pinScreen", "loadingScreen", "appScreen"].forEach(s =>
        document.getElementById(s).classList.remove("active")
      );
      document.getElementById(id).classList.add("active");
    }

    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // === Daily Quote ===
    function displayDailyQuote() {
      const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
      const quote = carmeliteQuotes[dayOfYear % carmeliteQuotes.length];
      document.getElementById("quoteText").textContent = quote.text;
      document.getElementById("quoteAuthor").textContent = "â€” " + quote.author;
    }

    // === Liturgical Calendar ===
    async function loadLiturgicalInfo() {
      const dateStr = today.toISOString().slice(0, 10);
      document.getElementById("liturgicalDate").textContent = today.toLocaleDateString("en-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });

      try {
        // Using the Catholic Calendar API
        const response = await fetch(`https://calapi.inadiutorium.cz/api/v0/en/calendars/default/${dateStr.replace(/-/g, '/')}`);
        const data = await response.json();
        
        if (data.celebrations && data.celebrations.length > 0) {
          const celebration = data.celebrations[0];
          document.getElementById("liturgicalFeast").textContent = celebration.title || "Ordinary Time";
          document.getElementById("liturgicalSeason").textContent = data.season || "";
          
          // Set liturgical color as border
          const banner = document.getElementById("liturgicalBanner");
          const colorMap = {
            'violet': 'var(--liturgical-advent)',
            'white': '#f0f0f0',
            'green': 'var(--liturgical-ordinary)',
            'red': '#c17b7b',
            'rose': 'var(--accent-rose)'
          };
          const color = colorMap[celebration.colour] || 'var(--accent-gold)';
          banner.style.borderLeftColor = color;
        }
      } catch (error) {
        console.log("Using fallback liturgical data");
        document.getElementById("liturgicalFeast").textContent = "Ordinary Time";
        document.getElementById("liturgicalSeason").textContent = "";
      }

      // Always show a scripture passage
      const passages = [
        "\"Ask and it will be given to you; seek and you will find.\" â€” Matthew 7:7",
        "\"The Lord is close to the brokenhearted.\" â€” Psalm 34:18",
        "\"Be still and know that I am God.\" â€” Psalm 46:10",
        "\"Pray without ceasing.\" â€” 1 Thessalonians 5:17",
        "\"The prayer of a righteous person is powerful.\" â€” James 5:16"
      ];
      const dayIndex = today.getDate() % passages.length;
      document.getElementById("liturgicalReading").textContent = passages[dayIndex];
    }

    // === Streak Calculation ===
    function calculateStreak() {
      const lastDate = streakData.lastPrayerDate;
      if (!lastDate) {
        streakData.currentStreak = 0;
        return;
      }

      const lastPrayerDate = new Date(lastDate);
      lastPrayerDate.setHours(0, 0, 0, 0);
      const daysDiff = Math.floor((today - lastPrayerDate) / 86400000);

      if (daysDiff === 0) {
        // Same day, keep streak
      } else if (daysDiff === 1) {
        // Yesterday, streak continues
      } else {
        // Streak broken
        streakData.currentStreak = 0;
      }

      document.getElementById("streakCount").textContent = streakData.currentStreak;
    }

    async function updateStreak() {
      const hasAnyPrayer =
        (todayDailyData.intentionsTotal && todayDailyData.intentionsTotal > 0) ||
        countTrue(todayDailyData.rosary) > 0 ||
        countTrue(todayDailyData.devotions) > 0 ||
        countTrue(todayDailyData.breviary) > 0;

      if (hasAnyPrayer && streakData.lastPrayerDate !== todayString) {
        const lastDate = streakData.lastPrayerDate ? new Date(streakData.lastPrayerDate) : null;
        if (lastDate) {
          lastDate.setHours(0, 0, 0, 0);
          const daysDiff = Math.floor((today - lastDate) / 86400000);
          if (daysDiff === 1) {
            streakData.currentStreak += 1;
          } else if (daysDiff > 1) {
            streakData.currentStreak = 1;
          }
        } else {
          streakData.currentStreak = 1;
        }

        await update(ref(db, "streak"), {
          currentStreak: streakData.currentStreak,
          lastPrayerDate: todayString
        });
      }
    }

    // === Goal Setting ===
    window.setDailyGoal = async () => {
      const currentGoal = globalSettings.dailyGoal;
      const newGoal = prompt("Set your new daily intention prayer goal:", currentGoal);
      if (newGoal === null || newGoal.trim() === "") return;
      const goalNum = parseInt(newGoal, 10);
      if (isNaN(goalNum) || goalNum < 1) {
        return showToast("Please enter a valid number.", "error");
      }
      try {
        await set(ref(db, "settings/dailyGoal"), goalNum);
        showToast("Goal updated!");
      } catch (e) {
        showToast("Error updating goal: " + e.message, "error");
      }
    };

    // === PIN Handler ===
    document.getElementById("pinSubmit").addEventListener("click", handlePINSubmit);
    document.getElementById("pinInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") handlePINSubmit();
    });

    async function handlePINSubmit() {
      const pin = document.getElementById("pinInput").value.trim();
      if (pin === CORRECT_PIN) {
        showScreen("loadingScreen");
        await initializeFirebase();
        setupApp();
      } else {
        showToast("Incorrect PIN.", "error");
        document.getElementById("pinInput").value = "";
      }
    }

    // === Firebase Init ===
    async function initializeFirebase() {
      try {
        ({ initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"));
        ({ getDatabase, ref, push, set, update, onValue, increment, get, query, orderByKey, limitToLast } =
          await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"));
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
      } catch (error) {
        console.error("Firebase Init Error:", error);
        showToast("Error loading app.", "error");
        showScreen("pinScreen");
      }
    }

    // === App Setup ===
    function setupApp() {
      showScreen("appScreen");
      document.getElementById("novenaStartDate").value = todayString;

      displayDailyQuote();
      loadLiturgicalInfo();
      setupUIListeners();
      loadSettings();
      loadStreak();
      loadIntentions();
      loadNovenas();
      loadAnsweredPrayers();
      loadDailyData(todayString);
    }

    // === Data Loading ===
    function loadSettings() {
      const settingsRef = ref(db, "settings");
      onValue(settingsRef, (snapshot) => {
        const s = snapshot.val() || {};
        globalSettings.dailyGoal = s.dailyGoal ? parseInt(s.dailyGoal, 10) : 100;
        updateDailyTally();
      });
    }

    function loadStreak() {
      const streakRef = ref(db, "streak");
      onValue(streakRef, (snapshot) => {
        const data = snapshot.val() || {};
        streakData.currentStreak = data.currentStreak || 0;
        streakData.lastPrayerDate = data.lastPrayerDate || null;
        calculateStreak();
      });
    }

    function loadIntentions() {
      const intentionsRef = ref(db, "intentions");
      const ordered = query(intentionsRef, orderByKey());
      onValue(ordered, (snapshot) => {
        activeIntentions = {};
        const data = snapshot.val() || {};
        for (const [id, item] of Object.entries(data)) {
          if (!item.deleted) activeIntentions[id] = { ...item, id };
        }
        renderIntentions();
        updateIntentionCounts();
      });
    }

    function loadNovenas() {
      const novenasRef = ref(db, "novenas");
      const ordered = query(novenasRef, orderByKey());
      onValue(ordered, (snapshot) => {
        activeNovenas = {};
        const data = snapshot.val() || {};
        for (const [id, item] of Object.entries(data)) {
          if (!item.deleted) activeNovenas[id] = { ...item, id };
        }
        renderNovenas();
      });
    }

    function loadAnsweredPrayers() {
      const answeredRef = ref(db, "answeredPrayers");
      const ordered = query(answeredRef, orderByKey());
      onValue(ordered, (snapshot) => {
        answeredPrayers = {};
        const data = snapshot.val() || {};
        for (const [id, item] of Object.entries(data)) {
          answeredPrayers[id] = { ...item, id };
        }
        renderAnsweredPrayers();
      });
    }

    function loadDailyData(dateString) {
      const dailyRef = ref(db, `dailyData/${dateString}`);
      onValue(dailyRef, (snapshot) => {
        todayDailyData = snapshot.val() || {};
        updateToggleButtons("rosary", todayDailyData.rosary);
        updateToggleButtons("devotions", todayDailyData.devotions);
        updateToggleButtons("breviary", todayDailyData.breviary);
        updateIntentionCounts();
        updateDailyTally();
        updateStreak();
        renderNovenas();
      });
    }

    const countTrue = (obj) => (obj ? Object.values(obj).filter(Boolean).length : 0);

    async function loadHistoryData() {
      const historyRef = ref(db, "dailyData");
      const historyQuery = query(historyRef, orderByKey(), limitToLast(30));
      const snapshot = await get(historyQuery);
      const data = snapshot.val() || {};
      
      const labels = [];
      const intentionData = [];
      const devotionData = [];
      const hourData = [];
      const totalPrayers = [];

      for (const [date, dailyData] of Object.entries(data)) {
        labels.push(date.substring(5));
        const intentions = dailyData.intentionsTotal || 0;
        const devotions = countTrue(dailyData.rosary) + countTrue(dailyData.devotions);
        const hours = countTrue(dailyData.breviary);
        
        intentionData.push(intentions);
        devotionData.push(devotions);
        hourData.push(hours);
        totalPrayers.push(intentions + devotions + hours);
      }

      renderHistoryChart(labels, intentionData, devotionData, hourData);
      renderConsistencyChart(labels, totalPrayers);
    }

    // === Rendering ===
    function renderIntentions() {
      const container = document.getElementById("intentionsList");
      const list = Object.values(activeIntentions).filter(i => !i.answered);
      
      if (list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âœŸ</div>
            <p>No active intentions yet</p>
          </div>
        `;
        return;
      }

      container.innerHTML = list
        .map(
          (intention) => `
        <div class="intention-card" data-id="${intention.id}">
          <div class="intention-header">
            <div class="intention-info">
              <h3 class="intention-title">${escapeHtml(intention.title)}</h3>
              ${intention.note ? `<p class="intention-note">${escapeHtml(intention.note)}</p>` : ""}
            </div>
            <div class="intention-actions">
              <button class="btn-icon" onclick="window.markIntentionAnswered('${intention.id}')" title="Mark as Answered">âœ“</button>
              <button class="btn-icon" onclick="window.deleteIntention('${intention.id}')" title="Delete">Ã—</button>
            </div>
          </div>
          <div class="intention-counter">
            <span class="counter-today" data-counter-id="${intention.id}">0</span>
            <span class="counter-label">prayers today</span>
          </div>
          <div class="counting-buttons">
            <button class="btn-count btn-count-1" onclick="window.addCount('${intention.id}', 1)">+1</button>
            <button class="btn-count btn-count-10" onclick="window.addCount('${intention.id}', 10)">+10</button>
            <button class="btn-count btn-count-100" onclick="window.addCount('${intention.id}', 100)">+100</button>
          </div>
        </div>
      `
        )
        .join("");
    }

    function renderNovenas() {
      const container = document.getElementById("novenasList");
      const list = Object.values(activeNovenas).filter(n => !n.answered);
      
      if (list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âœŸ</div>
            <p>No active novenas yet</p>
          </div>
        `;
        return;
      }

      const oneDay = 86400000;
      const checkIns = todayDailyData.novenaCheckIns || {};

      container.innerHTML = list
        .map((novena) => {
          const startDate = new Date(novena.startDate + "T00:00:00");
          const endDate = new Date(startDate.getTime() + (novena.type - 1) * oneDay);
          const diffDays = Math.round((today - startDate) / oneDay);
          let currentDay = diffDays + 1;
          let progressPercent = 0;
          let label = `Day ${currentDay} of ${novena.type}`;
          let canCheckIn = false;

          if (currentDay > novena.type) {
            label = `Completed on ${endDate.toLocaleDateString()}`;
            progressPercent = 100;
          } else if (currentDay < 1) {
            label = `Starts on ${startDate.toLocaleDateString()}`;
            progressPercent = 0;
          } else {
            progressPercent = (currentDay / novena.type) * 100;
            canCheckIn = true;
          }

          const isCheckedIn = checkIns[novena.id] === true;

          return `
            <div class="novena-card">
              <div class="novena-header">
                <div class="novena-info">
                  <h3 class="novena-title">${escapeHtml(novena.title)}</h3>
                  <p class="novena-for">${escapeHtml(novena.for || "")}</p>
                </div>
                <div class="novena-actions">
                  <button class="btn-icon" onclick="window.markNovenaAnswered('${novena.id}')" title="Mark as Answered">âœ“</button>
                  <button class="btn-icon" onclick="window.deleteNovena('${novena.id}')" title="Delete">Ã—</button>
                </div>
              </div>
              <div class="novena-progress">
                <p class="novena-progress-label">${label}</p>
                <div class="novena-progress-bar">
                  <div class="novena-progress-fill" style="width:${progressPercent}%"></div>
                </div>
              </div>
              <div class="novena-footer">
                <span class="novena-dates">${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}</span>
                <button class="btn btn-check-in" onclick="window.checkInNovena('${novena.id}')" ${!canCheckIn || isCheckedIn ? "disabled" : ""}>
                  ${isCheckedIn ? "Prayed Today" : "Check-in Today"}
                </button>
              </div>
            </div>
          `;
        })
        .join("");
    }

    function renderAnsweredPrayers() {
      const container = document.getElementById("answeredPrayersList");
      const list = Object.values(answeredPrayers).sort((a, b) => b.answeredDate - a.answeredDate);
      
      if (list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âœŸ</div>
            <p>Your answered prayers will appear here</p>
          </div>
        `;
        return;
      }

      container.innerHTML = list
        .map(
          (prayer) => `
        <div class="answered-prayer-card">
          <h3 class="answered-prayer-title">${escapeHtml(prayer.title)}</h3>
          <p class="answered-prayer-date">${new Date(prayer.answeredDate).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
          })}</p>
          ${prayer.testimony ? `<p class="answered-prayer-testimony">${escapeHtml(prayer.testimony)}</p>` : ""}
        </div>
      `
        )
        .join("");
    }

    function updateToggleButtons(type, data) {
      if (!data) data = {};
      document.querySelectorAll(`#${type}Grid .btn-toggle`).forEach((btn) => {
        const key = btn.dataset.key;
        btn.classList.toggle("active", !!data[key]);
      });
    }

    function updateIntentionCounts() {
      const byIntention = todayDailyData.intentionsBy || {};
      Object.keys(activeIntentions).forEach((id) => {
        const count = byIntention[id] || 0;
        const el = document.querySelector(`[data-counter-id="${id}"]`);
        if (el) el.textContent = count;
      });
    }

    function updateDailyTally() {
      const intentionCount = todayDailyData.intentionsTotal || 0;
      const devotionCount = countTrue(todayDailyData.rosary) + countTrue(todayDailyData.devotions);
      const hourCount = countTrue(todayDailyData.breviary);

      document.getElementById("tallyIntentionCount").textContent = intentionCount;
      document.getElementById("tallyDevotionCount").textContent = devotionCount;
      document.getElementById("tallyHourCount").textContent = hourCount;

      const goal = globalSettings.dailyGoal;
      document.getElementById("tallyGoalCount").textContent = intentionCount;
      document.getElementById("tallyGoalTarget").textContent = goal;
      const percent = Math.min(100, (intentionCount / goal) * 100);
      document.getElementById("goalProgressFill").style.width = `${percent}%`;
    }

    function renderHistoryChart(labels, intentionData, devotionData, hourData) {
      const ctx = document.getElementById("historyChart").getContext("2d");
      if (historyChart) historyChart.destroy();
      
      const isDark = document.body.classList.contains("dark-mode");
      const gridColor = isDark ? "rgba(255,255,255,.1)" : "rgba(0,0,0,.1)";
      const labelColor = isDark ? "#e5e5e5" : "#2c2c2c";
      const primary = isDark ? "rgba(212,175,55,.7)" : "rgba(139,69,19,.7)";
      const secondary = isDark ? "rgba(90,125,125,.7)" : "rgba(47,79,79,.7)";
      const tertiary = isDark ? "rgba(193,123,123,.7)" : "rgba(160,82,45,.7)";

      historyChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Intentions", data: intentionData, backgroundColor: primary },
            { label: "Devotions", data: devotionData, backgroundColor: secondary },
            { label: "Hours", data: hourData, backgroundColor: tertiary }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: { color: labelColor },
              stacked: true
            },
            x: {
              grid: { display: false },
              ticks: { color: labelColor },
              stacked: true
            }
          },
          plugins: {
            legend: { display: true, labels: { color: labelColor } }
          }
        }
      });
    }

    function renderConsistencyChart(labels, totalPrayers) {
      const ctx = document.getElementById("consistencyChart").getContext("2d");
      if (consistencyChart) consistencyChart.destroy();
      
      const isDark = document.body.classList.contains("dark-mode");
      const gridColor = isDark ? "rgba(255,255,255,.1)" : "rgba(0,0,0,.1)";
      const labelColor = isDark ? "#e5e5e5" : "#2c2c2c";
      
      // Color based on prayer count
      const backgroundColors = totalPrayers.map(count => {
        if (count === 0) return isDark ? "#3a3a3a" : "#e5e5e5";
        if (count < 5) return isDark ? "rgba(212,175,55,.3)" : "rgba(139,69,19,.3)";
        if (count < 20) return isDark ? "rgba(212,175,55,.6)" : "rgba(139,69,19,.6)";
        return isDark ? "rgba(212,175,55,1)" : "rgba(139,69,19,1)";
      });

      consistencyChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Total Prayers",
            data: totalPrayers,
            backgroundColor: backgroundColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: gridColor },
              ticks: { color: labelColor }
            },
            x: {
              grid: { display: false },
              ticks: { color: labelColor }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    // === Event Handlers ===
    function setupUIListeners() {
      // Navigation
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", (e) => {
          const viewId = e.target.dataset.view;
          document.querySelectorAll(".nav-link").forEach((l) => l.classList.remove("active"));
          e.target.classList.add("active");
          document.querySelectorAll(".app-view").forEach((v) => v.classList.remove("active"));
          document.getElementById(viewId).classList.add("active");
          if (viewId === "historyView") loadHistoryData();
        });
      });

      // Toggle buttons
      document.querySelectorAll(".btn-toggle").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const type = e.target.dataset.type;
          const key = e.target.dataset.key;
          const newVal = !todayDailyData[type]?.[key];
          const path = `dailyData/${todayString}/${type}/${key}`;
          set(ref(db, path), newVal);
        });
      });

      // Modals
      document.getElementById("addIntentionBtn").addEventListener("click", showIntentionModal);
      document.getElementById("closeModal").addEventListener("click", closeIntentionModal);
      document.getElementById("cancelIntentionModal").addEventListener("click", closeIntentionModal);
      document.getElementById("intentionForm").addEventListener("submit", handleIntentionSubmit);

      document.getElementById("addNovenaBtn").addEventListener("click", showNovenaModal);
      document.getElementById("closeNovenaModal").addEventListener("click", closeNovenaModal);
      document.getElementById("cancelNovenaModal").addEventListener("click", closeNovenaModal);
      document.getElementById("novenaForm").addEventListener("submit", handleNovenaSubmit);

      document.getElementById("closeAnsweredModal").addEventListener("click", closeAnsweredModal);
      document.getElementById("cancelAnsweredModal").addEventListener("click", () => {
        closeAnsweredModal();
        completeAnsweredMarking();
      });
      document.getElementById("answeredForm").addEventListener("submit", handleAnsweredSubmit);

      // Theme & Goal
      document.getElementById("themeToggle").addEventListener("click", toggleTheme);
      document.getElementById("setGoalBtn").addEventListener("click", window.setDailyGoal);
    }

    async function handleIntentionSubmit(e) {
      e.preventDefault();
      const title = document.getElementById("intentionTitle").value.trim();
      const note = document.getElementById("intentionNote").value.trim();
      if (!title) return;

      const data = {
        title,
        note,
        updatedAt: Date.now(),
        createdAt: Date.now(),
        deleted: false,
        answered: false
      };

      try {
        await set(push(ref(db, "intentions")), data);
        closeIntentionModal();
        showToast("Intention saved");
      } catch (error) {
        showToast("Error: " + error.message, "error");
      }
    }

    async function handleNovenaSubmit(e) {
      e.preventDefault();
      const title = document.getElementById("novenaTitle").value.trim();
      const novenaFor = document.getElementById("novenaFor").value.trim();
      const type = parseInt(document.getElementById("novenaType").value, 10);
      const startDate = document.getElementById("novenaStartDate").value;
      if (!title || !startDate) return;

      const data = {
        title,
        for: novenaFor,
        type,
        startDate,
        createdAt: Date.now(),
        deleted: false,
        answered: false
      };

      try {
        await set(push(ref(db, "novenas")), data);
        closeNovenaModal();
        showToast("Novena added");
      } catch (error) {
        showToast("Error: " + error.message, "error");
      }
    }

    let pendingAnsweredId = null;

    async function handleAnsweredSubmit(e) {
      e.preventDefault();
      const testimony = document.getElementById("answeredTestimony").value.trim();
      const intentionId = document.getElementById("answeredIntentionId").value;
      const title = document.getElementById("answeredIntentionTitle").value;

      if (testimony && intentionId && title) {
        await set(push(ref(db, "answeredPrayers")), {
          title,
          testimony,
          answeredDate: Date.now(),
          originalIntentionId: intentionId
        });
      }

      closeAnsweredModal();
      completeAnsweredMarking();
    }

    async function completeAnsweredMarking() {
      if (pendingAnsweredId) {
        await update(ref(db, `intentions/${pendingAnsweredId}`), { answered: true });
        showToast("Intention marked as answered");
        pendingAnsweredId = null;
      }
    }

    // === Global Functions ===
    window.addCount = (intentionId, delta) => {
      const updates = {};
      updates[`dailyData/${todayString}/intentionsTotal`] = increment(delta);
      updates[`dailyData/${todayString}/intentionsBy/${intentionId}`] = increment(delta);
      update(ref(db), updates);
    };

    window.checkInNovena = (novenaId) => {
      set(ref(db, `dailyData/${todayString}/novenaCheckIns/${novenaId}`), true);
    };

    window.deleteIntention = async (id) => {
      if (!confirm("Delete this intention?")) return;
      await update(ref(db, `intentions/${id}`), { deleted: true, deletedAt: Date.now() });
      showToast("Intention removed");
    };

    window.markIntentionAnswered = async (id) => {
      const intention = activeIntentions[id];
      if (!intention) return;
      
      pendingAnsweredId = id;
      document.getElementById("answeredIntentionId").value = id;
      document.getElementById("answeredIntentionTitle").value = intention.title;
      document.getElementById("answeredTestimony").value = "";
      document.getElementById("answeredModal").classList.add("active");
      document.getElementById("answeredTestimony").focus();
    };

    window.deleteNovena = async (id) => {
      if (!confirm("Delete this novena?")) return;
      await update(ref(db, `novenas/${id}`), { deleted: true, deletedAt: Date.now() });
      showToast("Novena removed");
    };

    window.markNovenaAnswered = async (id) => {
      const novena = activeNovenas[id];
      if (!novena) return;
      
      if (confirm(`Mark "${novena.title}" as answered?`)) {
        await update(ref(db, `novenas/${id}`), { answered: true });
        
        // Optionally save to answered prayers
        await set(push(ref(db, "answeredPrayers")), {
          title: novena.title,
          testimony: `Novena for: ${novena.for || ""}`,
          answeredDate: Date.now(),
          originalNovenaId: id,
          type: "novena"
        });
        
        showToast("Novena marked as answered");
      }
    };

    // === Modal Functions ===
    function showIntentionModal() {
      document.getElementById("modalTitle").textContent = "Add Intention";
      document.getElementById("intentionForm").reset();
      document.getElementById("intentionModal").classList.add("active");
      document.getElementById("intentionTitle").focus();
    }

    function closeIntentionModal() {
      document.getElementById("intentionModal").classList.remove("active");
    }

    function showNovenaModal() {
      document.getElementById("novenaForm").reset();
      document.getElementById("novenaStartDate").value = todayString;
      document.getElementById("novenaModal").classList.add("active");
      document.getElementById("novenaTitle").focus();
    }

    function closeNovenaModal() {
      document.getElementById("novenaModal").classList.remove("active");
    }

    function closeAnsweredModal() {
      document.getElementById("answeredModal").classList.remove("active");
    }

    function toggleTheme() {
      document.body.classList.toggle("dark-mode");
      const icon = document.querySelector(".theme-icon");
      icon.textContent = document.body.classList.contains("dark-mode") ? "â˜€" : "â˜¾";
      
      // Refresh charts if on history view
      if (document.getElementById("historyView").classList.contains("active")) {
        loadHistoryData();
      }
    }
  </script>
</body>
</html>