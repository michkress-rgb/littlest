<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Littlest Way Counter</title>
    <meta name="theme-color" content="#6b46c1">
    <style>
/* ============================================================================
   Littlest Way Counter - Styles
   Mobile-first, responsive design with dark mode support
   ============================================================================ */

/* ============================================================================
   CSS Variables & Reset
   ============================================================================ */

:root {
    /* Colors - Light Mode */
    --primary: #6b46c1;
    --primary-dark: #553399;
    --primary-light: #8b5cf6;
    --secondary: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    
    --bg-main: #f9fafb;
    --bg-card: #ffffff;
    --bg-overlay: rgba(0, 0, 0, 0.5);
    
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    
    --border: #e5e7eb;
    --shadow: rgba(0, 0, 0, 0.1);
    --shadow-lg: rgba(0, 0, 0, 0.15);
    
    /* Spacing */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    
    /* Typography */
    --font-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
    
    /* Border radius */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    
    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-base: 250ms ease;
    --transition-slow: 350ms ease;
}

/* Dark mode variables */
body.dark-mode {
    --bg-main: #111827;
    --bg-card: #1f2937;
    --bg-overlay: rgba(0, 0, 0, 0.7);
    
    --text-primary: #f9fafb;
    --text-secondary: #d1d5db;
    --text-muted: #9ca3af;
    
    --border: #374151;
    --shadow: rgba(0, 0, 0, 0.3);
    --shadow-lg: rgba(0, 0, 0, 0.5);
}

/* Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* ============================================================================
   Base Styles
   ============================================================================ */

body {
    font-family: var(--font-base);
    background-color: var(--bg-main);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
    transition: background-color var(--transition-base), color var(--transition-base);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ============================================================================
   Screen Management
   ============================================================================ */

.screen {
    display: none;
    min-height: 100vh;
    animation: fadeIn var(--transition-base);
}

.screen.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* ============================================================================
   PIN Lock Screen
   ============================================================================ */

#pinScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}

.pin-container {
    text-align: center;
    padding: var(--spacing-xl);
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: 0 20px 25px -5px var(--shadow-lg);
    max-width: 400px;
    width: 90%;
}

.pin-container h1 {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-md);
    color: var(--primary);
}

.subtitle {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-lg);
    font-size: 1rem;
}

.pin-input-group {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
}

.pin-input-group input {
    flex: 1;
    padding: var(--spacing-md);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 1.125rem;
    text-align: center;
    letter-spacing: 0.5em;
    transition: border-color var(--transition-fast);
    background: var(--bg-card);
    color: var(--text-primary);
}

.pin-input-group input:focus {
    outline: none;
    border-color: var(--primary);
}

.hint {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-style: italic;
}

/* ============================================================================
   Auth Screen
   ============================================================================ */

#authScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}

.auth-container {
    background: var(--bg-card);
    padding: var(--spacing-xl);
    border-radius: var(--radius-xl);
    box-shadow: 0 20px 25px -5px var(--shadow-lg);
    max-width: 400px;
    width: 90%;
}

.auth-container h1 {
    font-size: 2rem;
    text-align: center;
    color: var(--primary);
    margin-bottom: var(--spacing-sm);
}

.auth-container .subtitle {
    text-align: center;
    margin-bottom: var(--spacing-lg);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.auth-note {
    text-align: center;
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: var(--spacing-sm);
}

.error-message {
    color: var(--danger);
    font-size: 0.875rem;
    padding: var(--spacing-sm);
    background: rgba(239, 68, 68, 0.1);
    border-radius: var(--radius-sm);
    margin-top: var(--spacing-md);
    display: none;
}

.error-message:not(:empty) {
    display: block;
}

/* ============================================================================
   Form Elements
   ============================================================================ */

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.form-group label {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-primary);
}

.form-group input,
.form-group textarea {
    padding: var(--spacing-md);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-family: var(--font-base);
    transition: border-color var(--transition-fast);
    background: var(--bg-card);
    color: var(--text-primary);
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

/* ============================================================================
   Buttons
   ============================================================================ */

.btn {
    padding: var(--spacing-md) var(--spacing-lg);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    font-family: var(--font-base);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 6px var(--shadow);
}

.btn-primary:active:not(:disabled) {
    transform: translateY(0);
}

.btn-secondary {
    background: var(--text-secondary);
    color: white;
}

.btn-secondary:hover:not(:disabled) {
    background: var(--text-primary);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: #dc2626;
}

.btn-icon {
    background: transparent;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    transition: background-color var(--transition-fast);
    color: var(--text-secondary);
}

.btn-icon:hover {
    background: var(--border);
}

/* ============================================================================
   App Header
   ============================================================================ */

.app-header {
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    padding: var(--spacing-md) var(--spacing-lg);
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 1px 3px var(--shadow);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.app-header h1 {
    font-size: 1.5rem;
    color: var(--primary);
}

.header-actions {
    display: flex;
    gap: var(--spacing-sm);
}

.quote-display {
    text-align: center;
    font-style: italic;
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: var(--spacing-sm);
    min-height: 1.5rem;
    transition: opacity var(--transition-base);
}

.quote-fade {
    opacity: 0.5;
}

/* ============================================================================
   Main Content
   ============================================================================ */

.main-content {
    padding: var(--spacing-lg);
    max-width: 800px;
    margin: 0 auto;
}

.btn-add {
    width: 100%;
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-lg);
    font-size: 1.125rem;
}

/* ============================================================================
   Intentions List
   ============================================================================ */

.intentions-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-secondary);
}

.empty-state p:first-child {
    font-size: 1.5rem;
    margin-bottom: var(--spacing-sm);
}

/* ============================================================================
   Intention Card
   ============================================================================ */

.intention-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: 0 2px 4px var(--shadow);
    transition: all var(--transition-base);
    border: 1px solid var(--border);
}

.intention-card:hover {
    box-shadow: 0 4px 8px var(--shadow);
    transform: translateY(-2px);
}

.intention-card.count-pulse {
    animation: pulse 300ms ease;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

.intention-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-md);
}

.intention-info {
    flex: 1;
}

.intention-title {
    font-size: 1.25rem;
    margin-bottom: var(--spacing-xs);
    color: var(--text-primary);
}

.intention-note {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0;
}

.intention-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.intention-counter {
    text-align: center;
    padding: var(--spacing-md) 0;
    margin: var(--spacing-md) 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
}

.counter-today {
    display: block;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
    margin-bottom: var(--spacing-xs);
}

.counter-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.counting-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-sm);
}

.btn-count {
    padding: var(--spacing-lg);
    font-size: 1.25rem;
    font-weight: 700;
    border: 2px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    min-height: 60px;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.btn-count:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px var(--shadow);
}

.btn-count:active {
    transform: translateY(0);
    transition: transform 50ms;
}

.btn-count-1 {
    border-color: var(--secondary);
    color: var(--secondary);
}

.btn-count-1:hover {
    background: var(--secondary);
    color: white;
}

.btn-count-10 {
    border-color: var(--primary);
    color: var(--primary);
}

.btn-count-10:hover {
    background: var(--primary);
    color: white;
}

.btn-count-100 {
    border-color: var(--warning);
    color: var(--warning);
}

.btn-count-100:hover {
    background: var(--warning);
    color: white;
}

/* ============================================================================
   Chart Section
   ============================================================================ */

.chart-section {
    background: var(--bg-card);
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
    margin-top: var(--spacing-xl);
    border: 1px solid var(--border);
}

.chart-section h2 {
    font-size: 1.25rem;
    margin-bottom: var(--spacing-md);
    color: var(--text-primary);
}

#progressChart {
    width: 100%;
    height: auto;
    max-width: 100%;
}

/* ============================================================================
   Footer
   ============================================================================ */

.app-footer {
    position: sticky;
    bottom: 0;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    padding: var(--spacing-lg);
    box-shadow: 0 -2px 8px var(--shadow);
}

.global-counter {
    text-align: center;
    margin-bottom: var(--spacing-md);
}

.global-counter .counter-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.global-counter .counter-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    margin: var(--spacing-xs) 0 0;
}

.keyboard-hints {
    display: flex;
    justify-content: center;
    gap: var(--spacing-md);
    font-size: 0.75rem;
    color: var(--text-muted);
}

.keyboard-hints span {
    background: var(--border);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
}

/* ============================================================================
   Menu Overlay
   ============================================================================ */

.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-overlay);
    z-index: 100;
    display: none;
    animation: fadeIn var(--transition-base);
}

.overlay.active {
    display: flex;
    justify-content: flex-end;
}

.menu-panel {
    background: var(--bg-card);
    width: 100%;
    max-width: 400px;
    height: 100%;
    overflow-y: auto;
    box-shadow: -4px 0 12px var(--shadow-lg);
    animation: slideInRight var(--transition-base);
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
    }
    to {
        transform: translateX(0);
    }
}

.menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border);
}

.menu-header h2 {
    font-size: 1.5rem;
}

.menu-content {
    padding: var(--spacing-lg);
}

.menu-section {
    margin-bottom: var(--spacing-xl);
}

.menu-section h3 {
    font-size: 1rem;
    margin-bottom: var(--spacing-md);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.menu-section .btn {
    width: 100%;
    margin-bottom: var(--spacing-sm);
}

.user-info {
    background: var(--bg-main);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-lg);
}

.user-email {
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
}

.uid-display {
    font-size: 0.75rem;
    color: var(--text-muted);
    word-break: break-all;
}

.uid-display code {
    background: var(--border);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
}

.archived-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.archived-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm);
    background: var(--bg-main);
    border-radius: var(--radius-sm);
    gap: var(--spacing-sm);
}

.archived-item-content {
    flex: 1;
}

.archived-item-content strong {
    display: block;
    margin-bottom: var(--spacing-xs);
}

.archived-item-content p {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0;
}

/* ============================================================================
   Modals
   ============================================================================ */

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-overlay);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md);
    animation: fadeIn var(--transition-base);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px var(--shadow-lg);
    animation: scaleIn var(--transition-base);
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border);
}

.modal-header h2 {
    font-size: 1.5rem;
}

.modal form {
    padding: var(--spacing-lg);
}

.modal-actions {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border);
}

.modal-actions .btn {
    flex: 1;
}

#confirmModal .modal-content {
    max-width: 400px;
}

#confirmModal p {
    padding: var(--spacing-lg);
    color: var(--text-secondary);
}

/* ============================================================================
   Toast Notifications
   ============================================================================ */

.toast-container {
    position: fixed;
    bottom: var(--spacing-lg);
    left: 50%;
    transform: translateX(-50%);
    z-index: 300;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    pointer-events: none;
}

.toast {
    background: var(--text-primary);
    color: white;
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 12px var(--shadow-lg);
    font-weight: 500;
    transform: translateY(100px);
    opacity: 0;
    transition: all var(--transition-base);
    max-width: 90vw;
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast-error {
    background: var(--danger);
}

.toast-success {
    background: var(--secondary);
}

/* ============================================================================
   Responsive Design
   ============================================================================ */

@media (max-width: 640px) {
    .app-header h1 {
        font-size: 1.25rem;
    }
    
    .intention-card {
        padding: var(--spacing-md);
    }
    
    .intention-title {
        font-size: 1.125rem;
    }
    
    .counter-today {
        font-size: 2rem;
    }
    
    .counting-buttons {
        gap: var(--spacing-xs);
    }
    
    .btn-count {
        font-size: 1rem;
        padding: var(--spacing-md);
        min-height: 50px;
    }
    
    .keyboard-hints {
        flex-wrap: wrap;
        font-size: 0.625rem;
    }
    
    .menu-panel {
        max-width: 100%;
    }
}

@media (min-width: 641px) {
    .main-content {
        padding: var(--spacing-xl);
    }
    
    .intentions-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-lg);
    }
}

/* ============================================================================
   Accessibility
   ============================================================================ */

.btn:focus-visible,
.btn-icon:focus-visible,
input:focus-visible,
textarea:focus-visible {
    outline: 3px solid var(--primary);
    outline-offset: 2px;
}

@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ============================================================================
   Print Styles
   ============================================================================ */

@media print {
    .app-header,
    .app-footer,
    .btn,
    .menu-panel {
        display: none !important;
    }
    
    .intention-card {
        page-break-inside: avoid;
    }
}
    </style>
</head>
<body>
    <!-- PIN Lock Screen -->
    <div id="pinScreen" class="screen active">
        <div class="pin-container">
            <h1>üïäÔ∏è Littlest Way</h1>
            <p class="subtitle">Enter PIN to continue</p>
            <div class="pin-input-group">
                <input type="password" 
                       id="pinInput" 
                       inputmode="numeric" 
                       pattern="[0-9]*" 
                       maxlength="6" 
                       placeholder="Enter PIN"
                       autocomplete="off"
                       aria-label="Enter PIN">
                <button id="pinSubmit" class="btn btn-primary">Unlock</button>
            </div>
            <p class="hint">Hint: Your special number</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="screen">
        <div class="auth-container">
            <h1>üïäÔ∏è Littlest Way</h1>
            <p class="subtitle">Sign in to sync your acts of love</p>
            
            <form id="authForm" class="auth-form">
                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" 
                           id="authEmail" 
                           required 
                           autocomplete="email"
                           placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" 
                           id="authPassword" 
                           required 
                           autocomplete="current-password"
                           placeholder="Password">
                </div>
                <button type="submit" class="btn btn-primary" id="signInBtn">Sign In</button>
                <p class="auth-note">First time? Just sign in - your account will be created automatically.</p>
            </form>
            
            <div id="authError" class="error-message" role="alert"></div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="appScreen" class="screen">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1>üïäÔ∏è Littlest Way</h1>
                <div class="header-actions">
                    <button id="themeToggle" class="btn-icon" aria-label="Toggle dark mode" title="Toggle theme">
                        <span class="theme-icon">üåô</span>
                    </button>
                    <button id="menuBtn" class="btn-icon" aria-label="Open menu" title="Menu">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
            <div id="quoteDisplay" class="quote-display"></div>
        </header>

        <!-- Menu Overlay -->
        <div id="menuOverlay" class="overlay">
            <div class="menu-panel">
                <div class="menu-header">
                    <h2>Menu</h2>
                    <button id="closeMenu" class="btn-icon" aria-label="Close menu">‚úï</button>
                </div>
                <div class="menu-content">
                    <div class="user-info">
                        <p><strong>Signed in as:</strong></p>
                        <p id="userEmail" class="user-email"></p>
                        <p class="uid-display">UID: <code id="userUid"></code></p>
                    </div>
                    
                    <div class="menu-section">
                        <h3>Settings</h3>
                        <div class="form-group">
                            <label for="dailyGoalInput">Daily Goal (optional)</label>
                            <input type="number" id="dailyGoalInput" min="0" step="10" placeholder="e.g. 100">
                        </div>
                        <button id="saveSettings" class="btn btn-secondary">Save Settings</button>
                    </div>

                    <div class="menu-section">
                        <h3>Archived Intentions</h3>
                        <div id="archivedList" class="archived-list"></div>
                    </div>

                    <div class="menu-section">
                        <h3>Data Management</h3>
                        <button id="exportBtn" class="btn btn-secondary">üì• Export Data</button>
                        <button id="importBtn" class="btn btn-secondary">üì§ Import Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>

                    <div class="menu-section">
                        <button id="signOutBtn" class="btn btn-danger">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Add Intention Button -->
            <button id="addIntentionBtn" class="btn btn-primary btn-add">
                ‚ûï Add New Intention
            </button>

            <!-- Intentions List -->
            <div id="intentionsList" class="intentions-list">
                <!-- Intentions will be dynamically added here -->
            </div>

            <!-- Chart Section -->
            <div class="chart-section">
                <h2>Progress This Week</h2>
                <canvas id="progressChart" width="400" height="200"></canvas>
            </div>
        </main>

        <!-- Footer Stats -->
        <footer class="app-footer">
            <div class="global-counter">
                <p class="counter-label">Global total today</p>
                <p id="globalCount" class="counter-value">0</p>
            </div>
            <div class="keyboard-hints">
                <span>1: +1</span>
                <span>2: +10</span>
                <span>3: +100</span>
                <span>Z: Undo</span>
            </div>
        </footer>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="toast-container" role="status" aria-live="polite"></div>
    </div>

    <!-- Intention Modal -->
    <div id="intentionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Intention</h2>
                <button class="btn-icon" id="closeModal" aria-label="Close">‚úï</button>
            </div>
            <form id="intentionForm">
                <div class="form-group">
                    <label for="intentionTitle">Title *</label>
                    <input type="text" 
                           id="intentionTitle" 
                           required 
                           maxlength="100"
                           placeholder="e.g., For my family">
                </div>
                <div class="form-group">
                    <label for="intentionNote">Note (optional)</label>
                    <textarea id="intentionNote" 
                              rows="3" 
                              maxlength="500"
                              placeholder="Additional details..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveIntention">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirm</h2>
            </div>
            <p id="confirmMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
                <button class="btn btn-danger" id="confirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="app.js"></script>
    <script type="module">
// ============================================================================
// Littlest Way Counter - Main Application
// Firebase Realtime Database + Email/Password Auth
// ============================================================================

import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { 
    getDatabase, 
    ref, 
    push, 
    set, 
    update,
    onValue,
    increment,
    get,
    serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

// ============================================================================
// CONFIGURATION
// ============================================================================

// Your Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyC8h3coWuE2erx7QGQQkykproMDJsg3CUo",
    authDomain: "littlest-7ffe5.firebaseapp.com",
    databaseURL: "https://littlest-7ffe5-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "littlest-7ffe5",
    storageBucket: "littlest-7ffe5.firebasestorage.app",
    messagingSenderId: "97338367295",
    appId: "1:97338367295:web:5e1075caf990514a77078a"
};

const CORRECT_PIN = "332211";
const PIN_STORAGE_KEY = "lwc_unlocked";
const LAST_EVENT_KEY = "lwc_last_event";

// Devotional quotes
const QUOTES = [
    "Jesus, Mary, I love you. Save souls!",
    "Small acts of love, done with great love.",
    "Every little act of love counts in the eyes of God.",
    "Transform every moment into an offering of love.",
    "The Littlest Way: continuous acts of love for Jesus."
];

// i18n strings (expandable)
const STRINGS = {
    en: {
        addedCount: "Added",
        undone: "Undone",
        intentionSaved: "Intention saved",
        intentionArchived: "Intention archived",
        intentionUnarchived: "Intention unarchived",
        dataExported: "Data exported",
        dataImported: "Data imported successfully",
        settingsSaved: "Settings saved",
        error: "Error",
        today: "today"
    }
};

let currentLocale = 'en';

// ============================================================================
// GLOBAL STATE
// ============================================================================

let app, auth, db;
let currentUser = null;
let activeIntentions = {};
let todayCounts = null;
let listeners = [];
let currentEditingIntention = null;

// ============================================================================
// INITIALIZATION
// ============================================================================

function init() {
    // Initialize Firebase
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getDatabase(app);

    // Set up UI event listeners
    setupUIListeners();
    
    // Check PIN lock
    checkPINLock();
    
    // Monitor auth state
    onAuthStateChanged(auth, handleAuthStateChange);
}

// ============================================================================
// PIN LOCK
// ============================================================================

function checkPINLock() {
    const unlocked = localStorage.getItem(PIN_STORAGE_KEY);
    if (unlocked === "true") {
        showScreen('authScreen');
    } else {
        showScreen('pinScreen');
    }
}

function handlePINSubmit() {
    const pinInput = document.getElementById('pinInput');
    const enteredPIN = pinInput.value.trim();
    
    if (enteredPIN === CORRECT_PIN) {
        localStorage.setItem(PIN_STORAGE_KEY, "true");
        showScreen('authScreen');
        pinInput.value = '';
    } else {
        showToast('Incorrect PIN', 'error');
        pinInput.value = '';
        pinInput.focus();
    }
}

// ============================================================================
// AUTHENTICATION
// ============================================================================

async function handleAuthSubmit(e) {
    e.preventDefault();
    
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const errorDiv = document.getElementById('authError');
    const signInBtn = document.getElementById('signInBtn');
    
    errorDiv.textContent = '';
    signInBtn.disabled = true;
    signInBtn.textContent = 'Signing in...';
    
    try {
        // Try to sign in first
        await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
            // User doesn't exist, create account
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Initialize user profile
                await initializeUserProfile(userCredential.user);
            } catch (createError) {
                errorDiv.textContent = `Error: ${createError.message}`;
                signInBtn.disabled = false;
                signInBtn.textContent = 'Sign In';
            }
        } else {
            errorDiv.textContent = `Error: ${error.message}`;
            signInBtn.disabled = false;
            signInBtn.textContent = 'Sign In';
        }
    }
}

async function initializeUserProfile(user) {
    const userRef = ref(db, `users/${user.uid}/profile`);
    await set(userRef, {
        displayName: user.email.split('@')[0],
        locale: 'en',
        createdAt: Date.now()
    });
}

function handleAuthStateChange(user) {
    if (user) {
        currentUser = user;
        console.log('‚úÖ Authenticated user UID:', user.uid);
        console.log('üìã Copy this UID to firebaseRules.json');
        
        // Update UI
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userUid').textContent = user.uid;
        
        // Reset auth form
        document.getElementById('authForm').reset();
        document.getElementById('authError').textContent = '';
        document.getElementById('signInBtn').disabled = false;
        document.getElementById('signInBtn').textContent = 'Sign In';
        
        // Show app
        showScreen('appScreen');
        
        // Load user data
        loadUserData();
    } else {
        currentUser = null;
        // Clean up listeners
        cleanupListeners();
        // Show auth screen
        if (localStorage.getItem(PIN_STORAGE_KEY) === "true") {
            showScreen('authScreen');
        }
    }
}

async function handleSignOut() {
    try {
        await signOut(auth);
        showToast('Signed out successfully');
        // Don't clear PIN lock
    } catch (error) {
        showToast(`Error signing out: ${error.message}`, 'error');
    }
}

// ============================================================================
// DATA LOADING
// ============================================================================

function loadUserData() {
    if (!currentUser) return;
    
    const uid = currentUser.uid;
    
    // Load settings
    loadSettings(uid);
    
    // Load active intentions
    loadIntentions(uid);
    
    // Load today's counts
    loadTodayCounts(uid);
    
    // Rotate quotes
    rotateQuote();
    setInterval(rotateQuote, 30000); // Every 30 seconds
}

function loadSettings(uid) {
    const settingsRef = ref(db, `users/${uid}/settings`);
    const listener = onValue(settingsRef, (snapshot) => {
        const settings = snapshot.val() || {};
        
        // Apply dark mode
        if (settings.darkMode) {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-icon').textContent = '‚òÄÔ∏è';
        }
        
        // Update daily goal input
        if (settings.dailyGoal) {
            document.getElementById('dailyGoalInput').value = settings.dailyGoal;
        }
    });
    listeners.push(listener);
}

function loadIntentions(uid) {
    const intentionsRef = ref(db, `users/${uid}/intentions`);
    const listener = onValue(intentionsRef, (snapshot) => {
        activeIntentions = {};
        const intentionsData = snapshot.val() || {};
        
        // Filter active intentions
        for (const [id, intention] of Object.entries(intentionsData)) {
            if (!intention.archived) {
                activeIntentions[id] = { ...intention, id };
            }
        }
        
        renderIntentions();
        
        // Load archived list for menu
        loadArchivedIntentions(intentionsData);
    });
    listeners.push(listener);
}

function loadArchivedIntentions(allIntentions) {
    const archivedList = document.getElementById('archivedList');
    const archived = Object.entries(allIntentions)
        .filter(([_, intention]) => intention.archived)
        .map(([id, intention]) => ({ ...intention, id }));
    
    if (archived.length === 0) {
        archivedList.innerHTML = '<p class="empty-state">No archived intentions</p>';
        return;
    }
    
    archivedList.innerHTML = archived.map(intention => `
        <div class="archived-item">
            <div class="archived-item-content">
                <strong>${escapeHtml(intention.title)}</strong>
                ${intention.note ? `<p>${escapeHtml(intention.note)}</p>` : ''}
            </div>
            <button class="btn-icon" 
                    onclick="unarchiveIntention('${intention.id}')" 
                    title="Unarchive">
                ‚Ü©Ô∏è
            </button>
        </div>
    `).join('');
}

function loadTodayCounts(uid) {
    const today = getTodayString();
    const countsRef = ref(db, `users/${uid}/counts/${today}`);
    const listener = onValue(countsRef, (snapshot) => {
        todayCounts = snapshot.val() || { totals: { sum: 0 }, byIntention: {} };
        updateGlobalCounter();
        updateIntentionCounters();
    });
    listeners.push(listener);
}

function cleanupListeners() {
    listeners.forEach(unsubscribe => {
        if (typeof unsubscribe === 'function') {
            unsubscribe();
        }
    });
    listeners = [];
}

// ============================================================================
// INTENTIONS CRUD
// ============================================================================

function renderIntentions() {
    const container = document.getElementById('intentionsList');
    const intentionsArray = Object.values(activeIntentions);
    
    if (intentionsArray.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>‚ú® No intentions yet</p>
                <p>Add your first intention to start counting acts of love</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = intentionsArray
        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
        .map(intention => renderIntentionCard(intention))
        .join('');
}

function renderIntentionCard(intention) {
    const todayCount = todayCounts?.byIntention?.[intention.id]?.sum || 0;
    
    return `
        <div class="intention-card" data-id="${intention.id}">
            <div class="intention-header">
                <div class="intention-info">
                    <h3 class="intention-title">${escapeHtml(intention.title)}</h3>
                    ${intention.note ? `<p class="intention-note">${escapeHtml(intention.note)}</p>` : ''}
                </div>
                <div class="intention-actions">
                    <button class="btn-icon" 
                            onclick="editIntention('${intention.id}')" 
                            title="Edit" 
                            aria-label="Edit intention">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn-icon" 
                            onclick="archiveIntention('${intention.id}')" 
                            title="Archive" 
                            aria-label="Archive intention">
                        üì¶
                    </button>
                </div>
            </div>
            
            <div class="intention-counter">
                <span class="counter-today" data-intention="${intention.id}">${todayCount}</span>
                <span class="counter-label">${STRINGS[currentLocale].today}</span>
            </div>
            
            <div class="counting-buttons">
                <button class="btn-count btn-count-1" 
                        onclick="addCount('${intention.id}', 1)"
                        aria-label="Add 1">
                    +1
                </button>
                <button class="btn-count btn-count-10" 
                        onclick="addCount('${intention.id}', 10)"
                        aria-label="Add 10">
                    +10
                </button>
                <button class="btn-count btn-count-100" 
                        onclick="addCount('${intention.id}', 100)"
                        aria-label="Add 100">
                    +100
                </button>
            </div>
        </div>
    `;
}

function updateIntentionCounters() {
    if (!todayCounts) return;
    
    Object.keys(activeIntentions).forEach(intentionId => {
        const count = todayCounts.byIntention?.[intentionId]?.sum || 0;
        const counterEl = document.querySelector(`[data-intention="${intentionId}"]`);
        if (counterEl) {
            counterEl.textContent = count;
        }
    });
}

function showIntentionModal(intentionId = null) {
    const modal = document.getElementById('intentionModal');
    const modalTitle = document.getElementById('modalTitle');
    const titleInput = document.getElementById('intentionTitle');
    const noteInput = document.getElementById('intentionNote');
    
    currentEditingIntention = intentionId;
    
    if (intentionId) {
        const intention = activeIntentions[intentionId];
        modalTitle.textContent = 'Edit Intention';
        titleInput.value = intention.title;
        noteInput.value = intention.note || '';
    } else {
        modalTitle.textContent = 'Add Intention';
        titleInput.value = '';
        noteInput.value = '';
    }
    
    modal.classList.add('active');
    titleInput.focus();
}

async function saveIntention(e) {
    e.preventDefault();
    
    const title = document.getElementById('intentionTitle').value.trim();
    const note = document.getElementById('intentionNote').value.trim();
    
    if (!title) {
        showToast('Title is required', 'error');
        return;
    }
    
    const uid = currentUser.uid;
    
    try {
        if (currentEditingIntention) {
            // Update existing
            const intentionRef = ref(db, `users/${uid}/intentions/${currentEditingIntention}`);
            await update(intentionRef, {
                title,
                note,
                updatedAt: Date.now()
            });
        } else {
            // Create new
            const intentionsRef = ref(db, `users/${uid}/intentions`);
            const newIntentionRef = push(intentionsRef);
            await set(newIntentionRef, {
                title,
                note,
                archived: false,
                createdAt: Date.now()
            });
        }
        
        closeIntentionModal();
        showToast(STRINGS[currentLocale].intentionSaved);
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function archiveIntention(intentionId) {
    const intention = activeIntentions[intentionId];
    const confirmed = await showConfirm(
        'Archive Intention',
        `Archive "${intention.title}"? You can unarchive it later from the menu.`
    );
    
    if (!confirmed) return;
    
    const uid = currentUser.uid;
    const intentionRef = ref(db, `users/${uid}/intentions/${intentionId}`);
    
    try {
        await update(intentionRef, {
            archived: true,
            archivedAt: Date.now()
        });
        showToast(STRINGS[currentLocale].intentionArchived);
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function unarchiveIntention(intentionId) {
    const uid = currentUser.uid;
    const intentionRef = ref(db, `users/${uid}/intentions/${intentionId}`);
    
    try {
        await update(intentionRef, {
            archived: false,
            unarchivedAt: Date.now()
        });
        showToast(STRINGS[currentLocale].intentionUnarchived);
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function closeIntentionModal() {
    const modal = document.getElementById('intentionModal');
    modal.classList.remove('active');
    currentEditingIntention = null;
}

// ============================================================================
// COUNTING SYSTEM
// ============================================================================

async function addCount(intentionId, delta) {
    if (!currentUser) return;
    
    const uid = currentUser.uid;
    const today = getTodayString();
    const timestamp = Date.now();
    
    try {
        // 1. Create event
        const eventsRef = ref(db, `users/${uid}/events`);
        const newEventRef = push(eventsRef);
        const eventId = newEventRef.key;
        
        await set(newEventRef, {
            intentionId,
            delta,
            ts: timestamp,
            date: today
        });
        
        // 2. Atomic increment of totals
        const updates = {};
        updates[`users/${uid}/counts/${today}/totals/sum`] = increment(delta);
        updates[`users/${uid}/counts/${today}/byIntention/${intentionId}/sum`] = increment(delta);
        
        await update(ref(db), updates);
        
        // 3. Store for undo
        localStorage.setItem(LAST_EVENT_KEY, JSON.stringify({
            eventId,
            intentionId,
            delta,
            ts: timestamp,
            date: today
        }));
        
        // Visual feedback
        showToast(`${STRINGS[currentLocale].addedCount} +${delta}`);
        animateButton(intentionId, delta);
        
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function undoLastCount() {
    const lastEventStr = localStorage.getItem(LAST_EVENT_KEY);
    if (!lastEventStr) {
        showToast('Nothing to undo', 'error');
        return;
    }
    
    const lastEvent = JSON.parse(lastEventStr);
    const uid = currentUser.uid;
    
    // Check if the last event is from today
    const today = getTodayString();
    if (lastEvent.date !== today) {
        showToast('Can only undo today\'s counts', 'error');
        return;
    }
    
    try {
        // Create inverse event
        const eventsRef = ref(db, `users/${uid}/events`);
        const newEventRef = push(eventsRef);
        
        await set(newEventRef, {
            intentionId: lastEvent.intentionId,
            delta: -lastEvent.delta,
            ts: Date.now(),
            date: today,
            undoOf: lastEvent.eventId
        });
        
        // Atomic decrement
        const updates = {};
        updates[`users/${uid}/counts/${today}/totals/sum`] = increment(-lastEvent.delta);
        updates[`users/${uid}/counts/${today}/byIntention/${lastEvent.intentionId}/sum`] = increment(-lastEvent.delta);
        
        await update(ref(db), updates);
        
        // Clear undo buffer
        localStorage.removeItem(LAST_EVENT_KEY);
        
        showToast(`${STRINGS[currentLocale].undone} -${lastEvent.delta}`);
        
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function updateGlobalCounter() {
    const globalCount = todayCounts?.totals?.sum || 0;
    document.getElementById('globalCount').textContent = globalCount;
}

function animateButton(intentionId, delta) {
    // Find the card and add animation class
    const card = document.querySelector(`[data-id="${intentionId}"]`);
    if (card) {
        card.classList.add('count-pulse');
        setTimeout(() => card.classList.remove('count-pulse'), 300);
    }
}

// ============================================================================
// DATA EXPORT/IMPORT
// ============================================================================

async function exportData() {
    if (!currentUser) return;
    
    const uid = currentUser.uid;
    const userRef = ref(db, `users/${uid}`);
    
    try {
        const snapshot = await get(userRef);
        const data = snapshot.val() || {};
        
        // Create download
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `littlest-way-backup-${getTodayString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(STRINGS[currentLocale].dataExported);
    } catch (error) {
        showToast(`Export error: ${error.message}`, 'error');
    }
}

async function importData() {
    const fileInput = document.getElementById('importFile');
    fileInput.click();
}

async function handleImportFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const confirmed = await showConfirm(
        'Import Data',
        'This will replace all your current data. Are you sure?'
    );
    
    if (!confirmed) {
        e.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const data = JSON.parse(event.target.result);
            const uid = currentUser.uid;
            const userRef = ref(db, `users/${uid}`);
            
            await set(userRef, data);
            
            showToast(STRINGS[currentLocale].dataImported);
            e.target.value = '';
        } catch (error) {
            showToast(`Import error: ${error.message}`, 'error');
            e.target.value = '';
        }
    };
    
    reader.readAsText(file);
}

// ============================================================================
// SETTINGS
// ============================================================================

async function saveSettings() {
    if (!currentUser) return;
    
    const dailyGoal = parseInt(document.getElementById('dailyGoalInput').value) || null;
    const uid = currentUser.uid;
    const settingsRef = ref(db, `users/${uid}/settings`);
    
    try {
        await update(settingsRef, {
            dailyGoal,
            updatedAt: Date.now()
        });
        showToast(STRINGS[currentLocale].settingsSaved);
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function toggleTheme() {
    const isDark = document.body.classList.toggle('dark-mode');
    const icon = document.querySelector('.theme-icon');
    icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    
    // Save to Firebase
    if (currentUser) {
        const settingsRef = ref(db, `users/${currentUser.uid}/settings`);
        await update(settingsRef, { darkMode: isDark });
    }
}

// ============================================================================
// UI HELPERS
// ============================================================================

function setupUIListeners() {
    // PIN screen
    document.getElementById('pinSubmit').addEventListener('click', handlePINSubmit);
    document.getElementById('pinInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handlePINSubmit();
    });
    
    // Auth screen
    document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
    
    // Main app
    document.getElementById('addIntentionBtn').addEventListener('click', () => showIntentionModal());
    document.getElementById('intentionForm').addEventListener('submit', saveIntention);
    document.getElementById('closeModal').addEventListener('click', closeIntentionModal);
    document.getElementById('cancelModal').addEventListener('click', closeIntentionModal);
    
    // Menu
    document.getElementById('menuBtn').addEventListener('click', openMenu);
    document.getElementById('closeMenu').addEventListener('click', closeMenu);
    document.getElementById('signOutBtn').addEventListener('click', handleSignOut);
    document.getElementById('exportBtn').addEventListener('click', exportData);
    document.getElementById('importBtn').addEventListener('click', importData);
    document.getElementById('importFile').addEventListener('change', handleImportFile);
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    
    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcut);
    
    // Close modals on overlay click
    document.getElementById('intentionModal').addEventListener('click', (e) => {
        if (e.target.id === 'intentionModal') closeIntentionModal();
    });
    
    document.getElementById('menuOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'menuOverlay') closeMenu();
    });
}

function handleKeyboardShortcut(e) {
    // Only in app screen
    if (!document.getElementById('appScreen').classList.contains('active')) return;
    
    // Don't trigger if typing in input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    const intentionsArray = Object.values(activeIntentions);
    if (intentionsArray.length === 0) return;
    
    // Use first active intention for keyboard shortcuts
    const firstIntentionId = intentionsArray[0].id;
    
    switch(e.key.toLowerCase()) {
        case '1':
            e.preventDefault();
            addCount(firstIntentionId, 1);
            break;
        case '2':
            e.preventDefault();
            addCount(firstIntentionId, 10);
            break;
        case '3':
            e.preventDefault();
            addCount(firstIntentionId, 100);
            break;
        case 'z':
            e.preventDefault();
            undoLastCount();
            break;
    }
}

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
}

function openMenu() {
    document.getElementById('menuOverlay').classList.add('active');
}

function closeMenu() {
    document.getElementById('menuOverlay').classList.remove('active');
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
}

function showConfirm(title, message) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        
        modal.classList.add('active');
        
        const handleOk = () => {
            modal.classList.remove('active');
            cleanup();
            resolve(true);
        };
        
        const handleCancel = () => {
            modal.classList.remove('active');
            cleanup();
            resolve(false);
        };
        
        const cleanup = () => {
            document.getElementById('confirmOk').removeEventListener('click', handleOk);
            document.getElementById('confirmCancel').removeEventListener('click', handleCancel);
        };
        
        document.getElementById('confirmOk').addEventListener('click', handleOk);
        document.getElementById('confirmCancel').addEventListener('click', handleCancel);
    });
}

function rotateQuote() {
    const quoteDisplay = document.getElementById('quoteDisplay');
    const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
    quoteDisplay.textContent = randomQuote;
    quoteDisplay.classList.add('quote-fade');
    setTimeout(() => quoteDisplay.classList.remove('quote-fade'), 500);
}

// ============================================================================
// CHARTING
// ============================================================================

async function renderChart() {
    if (!currentUser) return;
    
    const canvas = document.getElementById('progressChart');
    const ctx = canvas.getContext('2d');
    const uid = currentUser.uid;
    
    // Get last 7 days
    const dates = [];
    const counts = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().slice(0, 10);
        dates.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        
        const countRef = ref(db, `users/${uid}/counts/${dateStr}/totals/sum`);
        const snapshot = await get(countRef);
        counts.push(snapshot.val() || 0);
    }
    
    // Simple bar chart rendering
    const maxCount = Math.max(...counts, 10);
    const barWidth = canvas.width / dates.length;
    const padding = 10;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw bars
    counts.forEach((count, i) => {
        const barHeight = (count / maxCount) * (canvas.height - 40);
        const x = i * barWidth + padding;
        const y = canvas.height - barHeight - 20;
        
        ctx.fillStyle = '#6b46c1';
        ctx.fillRect(x, y, barWidth - 2 * padding, barHeight);
        
        // Draw count
        ctx.fillStyle = '#333';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(count, x + barWidth / 2 - padding, y - 5);
        
        // Draw date
        ctx.fillText(dates[i], x + barWidth / 2 - padding, canvas.height - 5);
    });
}

// Update chart when data changes
setInterval(() => {
    if (currentUser && document.getElementById('appScreen').classList.contains('active')) {
        renderChart();
    }
}, 60000); // Every minute

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function getTodayString() {
    return new Date().toISOString().slice(0, 10);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Make functions globally accessible for inline onclick handlers
window.addCount = addCount;
window.editIntention = (id) => showIntentionModal(id);
window.archiveIntention = archiveIntention;
window.unarchiveIntention = unarchiveIntention;

// ============================================================================
// START APP
// ============================================================================

// ============================================================================
// SERVICE WORKER REGISTRATION (PWA)
// ============================================================================

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('‚úÖ Service Worker registered:', registration.scope);
            })
            .catch((error) => {
                console.log('‚ùå Service Worker registration failed:', error);
            });
    });
}

// ============================================================================
// START APP
// ============================================================================

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
    </script>
</body>
</html>
